{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block body %}

<main id="main" class="main">

        <div class="pagetitle d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1>Leaves</h1>
                <nav>
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="#">Home</a></li>
                        <li class="breadcrumb-item active">leaves</li>
                    </ol>
                </nav>
            </div>
        </div>
    <div class="row g-4 mb-4">
                <div class="col-12">
                    <div class="card recent-sales overflow-auto h-100">
                        <div class="card-body">
                            <h5 class="card-title">Actions</h5>
                            <!-- Modal 1-->
                            <!-- Button trigger modal -->
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">Apply for Leave</button>
                        </div>
                    </div>
                </div>
    </div>



<!-- Modal 1-->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Apply for Leave</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
            <form method="post">
                {% csrf_token %}
                <div class="mb-3">
                    <label class="form-label">{{ form.leave_type.label }}</label>
                    {{ form.leave_type }}
                    {{ form.leave_type.errors }}
                </div>

                <div class="mb-3">
                    <label class="form-label">{{ form.reason.label }}</label>
                    {{ form.reason }}
                    {{ form.reason.errors }}
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">{{ form.start_date.label }}</label>
                        {{ form.start_date }}
                        {{ form.start_date.errors }}
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label">{{ form.end_date.label }}</label>
                        {{ form.end_date }}
                        {{ form.end_date.errors }}
                    </div>
                </div>

                <div class="mb-3 text-center">
                    <strong>Total Leave Days:</strong>
                    <span id="total-days">0</span>
                </div>

                <div class="text-center">
                    <button type="submit" class="btn btn-primary">Submit Application</button>
                </div>
            </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

    <div class="row g-4 mb-4">
                <div class="col-12">
                    <div class="card recent-sales overflow-auto h-100">
                        <div class="card-body">
                            <h5 class="card-title">Leave Balance</h5>
                            <table class="table table-bordered">
                              <thead>
                                <tr>
                                  <th scope="col">Leave Type</th>
                                  <th scope="col">Total Allotted</th>
                                  <th scope="col">Leaves Taken</th>
                                  <th scope="col">Remaining</th>
                                </tr>
                              </thead>
                              <tbody>
                                <tr>
                                  <th scope="row">Sick Leave</th>
                                  <td>{{ leave_summary.sick.allotted }}</td>
                                  <td>{{ leave_summary.sick.taken }}</td>
                                  <td>{{ leave_summary.sick.remaining }}</td>
                                </tr>
                                <tr>
                                  <th scope="row">Casual Leave</th>
                                  <td>{{ leave_summary.casual.allotted }}</td>
                                  <td>{{ leave_summary.casual.taken }}</td>
                                  <td>{{ leave_summary.casual.remaining }}</td>
                                </tr>
                                <tr>
                                  <th scope="row">Earned Leave</th>
                                  <td>{{ leave_summary.earned.allotted }}</td>
                                  <td>{{ leave_summary.earned.taken }}</td>
                                    <td>{{ leave_summary.earned.remaining }}</td>
                                </tr>
                                <tr>
                                  <th scope="row">Total</th>
                                  <td>20</td>
                                  <td>{{ leave_summary.total_taken }}</td>
                                    <td>{{ leave_summary.total_remaining }}</td>
                                </tr>
                              </tbody>
                            </table>
                        </div>
                    </div>
                </div>
    </div>

    <div class="row g-4 mb-4">
                <div class="col-12">
                    <div class="card recent-sales overflow-auto h-100">
                        <div class="card-body">
                            <h5 class="card-title">Previous Leave Requests</h5>
                            <table class="table table-bordered">
                              <thead>
                                <tr>
                                  <th scope="col">Sr. No.</th>
                                  <th scope="col">Leave Type</th>
                                  <th scope="col">Start Date</th>
                                  <th scope="col">End Date</th>
                                    <th scope="col">Total Days</th>
                                    <th scope="col">Reason</th>
                                    <th scope="col">Status</th>
                                </tr>
                              </thead>
                              <tbody>
                                {% for item in all_items %}
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                  <td>{{ item.leave_type.capitalize }}</td>
                                    <td>{{ item.start_date }}</td>
                                    <td>{{ item.end_date }}</td>
                                    <td>{{ item.duration }}</td>
                                    <td>{{ item.reason }}</td>
                                    {% if item.status == 'pending' %}
                                        <td class="text-warning">{{ item.status.capitalize }}</td>
                                    {% elif item.status == 'approved' %}
                                        <td class="text-success">{{ item.status.capitalize }}</td>
                                    {% else %}
                                        <td class="text-danger">{{ item.status.capitalize }}</td>
                                    {% endif %}
                                    <td>
                                        {% if item.status == 'pending' %}
                                            <!-- Button trigger modal -->
                                            <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
                                              <i class="bi bi-trash"></i>
                                            </button>

                                            <!-- Modal -->
                                            <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                                              <div class="modal-dialog modal-dialog-centered">
                                                <div class="modal-content">
                                                  <div class="modal-header">
                                                    <h5 class="modal-title" id="staticBackdropLabel">Delete Request!!</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                  </div>
                                                  <div class="modal-body">
                                                    <p class="h6">Do you want to <i class="text-danger">Delete</i> the Leave request?</p>
                                                      <div class="mb-3 text-center">
                                                      <a href="{% url 'leave-delete' item.pk %}" class="btn btn-outline-danger m-1">Delete</a>
                                                      <button type="button" class="btn btn-outline-primary m-1" data-bs-dismiss="modal">Cancel</button>
                                                      </div>
                                                  </div>
                                                </div>
                                              </div>
                                            </div>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                              </tbody>
                            </table>
                        </div>
                    </div>
                </div>
    </div>

    <script>
        //JS for dynamic update of number of days when selecting start date and end date
    document.addEventListener("DOMContentLoaded", function () {
        const startInput = document.getElementById("id_start_date");
        const endInput = document.getElementById("id_end_date");
        const output = document.getElementById("total-days");

        function calculateDays() {
            if (!startInput.value || !endInput.value) {
                output.textContent = "0";
                return;
            }

            const startDate = new Date(startInput.value);
            const endDate = new Date(endInput.value);

            if (endDate < startDate) {
                output.textContent = "0";
                return;
            }

            // Difference in milliseconds
            const diffTime = endDate - startDate;

            // Convert to days and add 1 (inclusive)
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;

            output.textContent = diffDays;
        }

        startInput.addEventListener("change", calculateDays);
        endInput.addEventListener("change", calculateDays);
    });


    </script>
</main>
{% endblock body %}