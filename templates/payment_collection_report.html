{% extends "base.html" %}
{% block body %}

<main id="main" class="main">

  <div class="pagetitle">
    <h1>Payment Collection Report</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item">
          <a href="{% url 'dashboard' %}">Home</a>
        </li>
        <li class="breadcrumb-item active">Admin Reports</li>
      </ol>
    </nav>
  </div>

  <section class="section">

    <!-- ACCORDION FILTER SECTION -->
    <div class="accordion mb-4" id="reportFilterAccordion">
      <div class="accordion-item border-0 shadow-sm">

        <h2 class="accordion-header" id="headingFilter">
          <button class="accordion-button collapsed bg-white text-primary fw-bold"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#collapseFilter">
            <i class="bi bi-funnel-fill me-2"></i> Filter Report
          </button>
        </h2>

        <div id="collapseFilter"
             class="accordion-collapse collapse"
             data-bs-parent="#reportFilterAccordion">

          <div class="accordion-body bg-light">

            <form method="get">
              <div class="row g-3">

                <!-- Employees -->
                <div class="col-12 col-md-3">
                  <label class="form-label small fw-bold text-secondary">
                    Employees
                  </label>
                  <select name="client" class="form-select w-100">
                    <option value="">All Employees</option>
                    {% for client in clients %}
                      <option value="{{ client.id }}"
                        {% if selected_client == client.id|stringformat:"s" %}selected{% endif %}>
                        {{ client.client_name }}
                      </option>
                    {% endfor %}
                  </select>
                </div>

                <!-- From Date -->
                <div class="col-12 col-md-3">
                  <label class="form-label small fw-bold text-secondary">
                    Payment Date From
                  </label>
                  <input type="date"
                         name="start_date"
                         class="form-control w-100"
                         value="{{ start_date|date:'Y-m-d' }}">
                </div>

                <!-- To Date -->
                <div class="col-12 col-md-3">
                  <label class="form-label small fw-bold text-secondary">
                    Payment Date To
                  </label>
                  <input type="date"
                         name="end_date"
                         class="form-control w-100"
                         value="{{ end_date|date:'Y-m-d' }}">
                </div>

                <!-- Buttons -->
                <div class="col-12 col-md-3 d-flex align-items-end">
                  <div class="d-grid gap-2 w-100 d-md-flex">
                    <button type="submit" class="btn btn-primary w-100">
                      <i class="bi bi-search me-1"></i> Apply
                    </button>
                    <a href="{% url 'payment_collection_report' %}"
                       class="btn btn-outline-secondary w-100">
                      <i class="bi bi-arrow-clockwise me-1"></i> Reset
                    </a>
                  </div>
                </div>

              </div>
            </form>

          </div>
        </div>
      </div>
    </div>

    <!-- TABLE CARD -->
    <div class="card shadow-sm border-0">
      <div class="card-body">

        <!-- Header -->
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 gap-2">
          <h5 class="card-title m-0">Collection Summary</h5>
          <small class="text-muted">
            {{ start_date|date:"d M Y" }} – {{ end_date|date:"d M Y" }}
          </small>
        </div>

        <!-- Responsive Table -->
        <div class="table-responsive">
          <table class="table table-hover table-sm datatable align-middle">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>Username</th>
                <th>Credit</th>
                <th>Debit</th>
                <th>Net Balance</th>
              </tr>
            </thead>
            <tbody>
              {% for row in report_data %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td>
                  <a href="{% url 'payment_collection_detail' row.invoice__client__id %}">
                    {{ row.invoice__client__client_name }}
                  </a>
                </td>
                <td class="text-success fw-bold">₹ {{ row.credit|default:0 }}</td>
                <td class="text-danger fw-bold">₹ 0</td>
                <td class="text-success fw-bold">₹ {{ row.credit|default:0 }}</td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="5" class="text-center">No data found.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      </div>
    </div>

    <!-- Payment Details -->
    {% if payment_details %}
    <div class="card mt-4 shadow-sm border-0">
      <div class="card-body">
        <h5 class="card-title">Payment Details</h5>

        <div class="table-responsive">
          <table class="table table-hover table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th>Date</th>
                <th>Client</th>
                <th>Amount</th>
                <th>Collected By</th>
              </tr>
            </thead>
            <tbody>
              {% for payment in payment_details %}
              <tr>
                <td>{{ payment.payment_date }}</td>
                <td>{{ payment.invoice.client.client_name }}</td>
                <td class="text-success fw-bold">₹ {{ payment.amount }}</td>
                <td>{{ payment.created_by.username }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      </div>
    </div>
    {% endif %}

  </section>
</main>

{% endblock %}