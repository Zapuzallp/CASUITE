{% extends 'base.html' %}
{% load static %}

{% block body %}
<main id="main" class="main">

    <div class="pagetitle">
        <h1>Clients</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Home</a></li>
                <li class="breadcrumb-item active">Clients</li>
            </ol>
        </nav>
    </div>

    {% if messages %}
        <div class="container-fluid p-0">
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                <i class="bi bi-info-circle me-1"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
        </div>
    {% endif %}

    <section class="section">
        <div class="row">
            <div class="col-lg-12">

                <!-- ACCORDION FILTER SECTION -->
                <div class="accordion mb-4" id="clientFilterAccordion">
                    <div class="accordion-item border-0 shadow-sm">
                        <h2 class="accordion-header" id="headingOne">
                            <button class="accordion-button {% if not request.GET %}collapsed{% endif %} bg-white text-primary fw-bold"
                                    type="button"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#collapseFilter"
                                    aria-expanded="{% if request.GET %}true{% else %}false{% endif %}"
                                    aria-controls="collapseFilter">
                                <i class="bi bi-funnel-fill me-2"></i> Filter Clients
                            </button>
                        </h2>
                        <div id="collapseFilter"
                             class="accordion-collapse collapse {% if request.GET %}show{% endif %}"
                             aria-labelledby="headingOne"
                             data-bs-parent="#clientFilterAccordion">
                            <div class="accordion-body bg-light">
                                <form method="get" action=".">
                                    <div class="row g-3">

                                        <!-- Search Text -->
                                        <div class="col-md-3">
                                            <label class="form-label small fw-bold text-secondary">Search</label>
                                            <input type="text" name="q" class="form-control" id="searchInput"
                                                   placeholder="Name, PAN, File No, GST No..." value="{{ request.GET.q }}">
                                        </div>

                                        <!-- Office Location -->
                                        <div class="col-md-3">
                                            <label class="form-label small fw-bold text-secondary">Branch /
                                                Office</label>
                                            <select name="office" class="form-select">
                                                <option value="">All Branches</option>
                                                {% for office in offices %}
                                                    <option value="{{ office.id }}"
                                                            {% if request.GET.office == office.id|stringformat:"i" %}selected{% endif %}>
                                                        {{ office.office_name }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>

                                        <!-- Assigned Employee Filter (Conditionally Rendered) -->
                                        {% if assigned_employee_choices %}
                                            <div class="col-md-3">
                                                <label class="form-label small fw-bold text-secondary">Assigned
                                                    Employee</label>
                                                <select name="assigned_to" class="form-select">
                                                    <option value="">All Employees</option>
                                                    {% for emp_user in assigned_employee_choices %}
                                                        <option value="{{ emp_user.id }}"
                                                                {% if request.GET.assigned_to == emp_user.id|stringformat:"i" %}selected{% endif %}>
                                                            {{ emp_user.get_full_name|default:emp_user.username }}
                                                        </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        {% endif %}

                                        <!-- Task Service Type -->
                                        <div class="col-md-3">
                                            <label class="form-label small fw-bold text-secondary">Task / Service
                                                Type</label>
                                            <select name="task_type" class="form-select border-primary bg-white">
                                                <option value="">All Task Types</option>
                                                {% for task_type in task_types %}
                                                    <option value="{{ task_type.task_type_value }}"
                                                            {% if request.GET.task_type == task_type.task_type_value %}selected{% endif %}>
                                                        {{ task_type.task_type_name }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                            <div class="form-text x-small">Shows clients with this task type</div>
                                        </div>

                                        <!-- Status -->
                                        <div class="col-md-3">
                                            <label class="form-label small fw-bold text-secondary">Status</label>
                                            <select name="status" class="form-select">
                                                <option value="">All Statuses</option>
                                                {% for code, name in status_choices %}
                                                    <option value="{{ code }}"
                                                            {% if request.GET.status == code %}selected{% endif %}>
                                                        {{ name }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>

                                        <!-- Client Type -->
                                        <div class="col-md-3">
                                            <label class="form-label small fw-bold text-secondary">Client Type</label>
                                            <select name="client_type" class="form-select">
                                                <option value="">All Types</option>
                                                {% for code, name in client_type_choices %}
                                                    <option value="{{ code }}"
                                                            {% if request.GET.client_type == code %}selected{% endif %}>
                                                        {{ name }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>

                                        <!-- Business Structure -->
                                        <div class="col-md-3">
                                            <label class="form-label small fw-bold text-secondary">Structure</label>
                                            <select name="business_structure" class="form-select">
                                                <option value="">All Structures</option>
                                                {% for code, name in business_structure_choices %}
                                                    <option value="{{ code }}"
                                                            {% if request.GET.business_structure == code %}selected{% endif %}>
                                                        {{ name }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>

                                       <!-- aadhar_linked_mobile -->
                                        <div class="col-md-3">
                                            <label class="form-label small fw-bold text-secondary">Aadhar Linked to mobile </label>
                                            <select name="aadhar_linked_mobile" class="form-select">
                                                <option value="">All type</option>
                                                {% for value, label in aadhar_linked_mobile_choices %}
                                            <option value="{{ value }}" {% if request.GET.aadhar_linked_mobile == value %}selected{% endif %} >
                                                {{ label }}
                                            </option>
                                                {% endfor %}
                                            </select>
                                        </div>

                                        <!-- DIN_number -->
                                        <div class="col-md-3">
                                            <label class="form-label small fw-bold text-secondary">DIN number </label>
                                            <select name="din_no" class="form-select">
                                                <option value="">All type</option>
                                                {% for value in din_no_choices %}
                                                <option value="{{ value }}" {% if request.GET.DIN_number == value %}selected{% endif %} >
                                                {{ value }}
                                            </option>
                                                {% endfor %}
                                            </select>
                                        </div>

                                        <!-- Filter Actions -->
                                        <div class="col-md-6 d-flex align-items-end">
                                            <button type="submit" class="btn btn-primary me-2">
                                                <i class="bi bi-search"></i> Apply Filters
                                            </button>
                                            <a href="{% url 'clients' %}" class="btn btn-secondary">
                                                <i class="bi bi-x-circle"></i> Clear
                                            </a>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TABLE SECTION -->
                <div class="card overflow-auto shadow-sm">
                    <div class="card-body">

                        <div class="d-flex justify-content-between align-items-center my-3">
                            <div>
                                <h5 class="card-title m-0">Clients Directory</h5>
                                {% if is_paginated %}
                                    <small class="text-muted">Showing {{ page_obj.start_index }}
                                        - {{ page_obj.end_index }} of {{ paginator.count }} result(s)</small>
                                {% else %}
                                    <small class="text-muted">Showing {{ clients|length }} result(s)</small>
                                {% endif %}
                            </div>
                            <a href="{% url 'onboard_client' %}" class="btn btn-primary btn-sm">
                                <i class="bi bi-plus-circle me-1"></i> Add New Client
                            </a>
                        </div>

                        <table class="table table-borderless table-hover align-middle" id="clientsTable">
                            <thead class="table-light">
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">Client Name / ID</th>
                                <th scope="col">Primary Contact</th>
                                <th scope="col">Office</th>
                                <th scope="col">Structure</th>
                                <th scope="col">Status</th>
                                <th scope="col">Assigned CA</th>
                                <th scope="col" class="text-center">Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for client in clients %}
                                <tr {% if client.assigned_ca == request.user %}class="table-light"{% endif %}>
                                    <th scope="row">
                                        {% if is_paginated %}
                                            {{ page_obj.start_index|add:forloop.counter0 }}
                                        {% else %}
                                            {{ forloop.counter }}
                                        {% endif %}
                                    </th>

                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="fw-bold text-primary">
                                                <a href="/client/{{ client.id }}/details/">{{ client.client_name }}</a>
                                            </div>
                                            {% if client.assigned_ca == request.user %}
                                                <span class="badge rounded-pill bg-primary ms-2"
                                                      style="font-size: 0.65rem;" title="Assigned to You">
                                                    <i class="bi bi-person-check-fill"></i> Me
                                                </span>
                                            {% endif %}
                                        </div>
                                        <div class="small text-muted" style="font-size: 12px;">
                                            <i class="bi bi-card-heading"></i> {{ client.pan_no }}
                                            {% if client.file_number %}
                                                | <i class="bi bi-file-earmark-text"></i> {{ client.file_number }}
                                            {% endif %}
                                        </div>
                                    </td>

                                    <td>
                                        <div class="fw-semibold">{{ client.primary_contact_name }}</div>
                                        <div class="text-muted small"><i
                                                class="bi bi-phone"></i> {{ client.phone_number }}</div>
                                    </td>

                                    <td>
                                        {% if client.office_location %}
                                            <span class="badge bg-light text-secondary border">
                                                {{ client.office_location.office_name }}
                                            </span>
                                        {% else %}
                                            <span class="text-muted fst-italic small">-</span>
                                        {% endif %}
                                    </td>

                                    <td>
                                        {% if client.business_structure %}
                                            <span class="badge bg-light text-dark border">
                                                {{ client.business_structure }}
                                            </span>
                                        {% else %}
                                            <span class="badge bg-info text-white">
                                                {{ client.client_type }}
                                            </span>
                                        {% endif %}
                                    </td>

                                    <td>
                                        <span class="badge rounded-pill
                                            {% if client.status == 'Incorporated' %}bg-success
                                            {% elif client.status == 'Prospect' %}bg-warning text-dark
                                            {% elif client.status == 'Incorporation in progress' %}bg-info text-dark
                                            {% elif client.status == 'Closed' %}bg-danger
                                            {% else %}bg-secondary{% endif %}">
                                            {{ client.status }}
                                        </span>
                                    </td>

                                    <td>
                                        {% if client.assigned_ca %}
                                            <div class="d-flex align-items-center">
                                                {% if client.assigned_ca.employee.profile_pic %}
                                                    <img src="{{ client.assigned_ca.employee.profile_pic.url }}"
                                                         alt="img" class="rounded-circle me-1"
                                                         style="width:20px; height:20px;">
                                                {% else %}
                                                    <i class="bi bi-person-circle me-1 text-secondary"></i>
                                                {% endif %}
                                                <span class="small {% if client.assigned_ca == request.user %}fw-bold text-primary{% endif %}">
                                                    {{ client.assigned_ca.get_full_name|default:client.assigned_ca.username }}
                                                </span>
                                            </div>
                                        {% else %}
                                            <span class="text-muted fst-italic small">Unassigned</span>
                                        {% endif %}
                                    </td>

                                    <td class="text-center">
                                        <div class="btn-group" role="group">

                                            <!-- WHATSAPP INTEGRATION -->
                                            <a href="javascript:void(0);"
                                               onclick="sendWhatsApp('{{ client.phone_number|default:'' }}', '{{ client.client_name|escapejs }}', '{{ client.file_number|default:'' }}')"
                                               class="btn btn-sm btn-outline-success"
                                               title="Send WhatsApp Message">
                                                <i class="bi bi-whatsapp"></i>
                                            </a>

                                            <!-- View Details -->
                                            <a href="/client/{{ client.id }}/details/"
                                               class="btn btn-sm btn-outline-secondary" title="View Details">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            <!-- Edit Client -->
                                            <a href="{% url 'edit_client' client.id %}"
                                               class="btn btn-sm btn-outline-primary" title="Edit Client">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center py-4">
                                        <div class="text-muted">
                                            <i class="bi bi-inbox fs-2"></i>
                                            <p class="mt-2">No clients found matching criteria.</p>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>

                        <!-- PAGINATION CONTROLS -->
                        {% if is_paginated %}
                            <nav aria-label="Page navigation" class="mt-4">
                                <ul class="pagination justify-content-center">
                                    <!-- Previous Page -->
                                    {% if page_obj.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page=
                                                    {{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                                               aria-label="Previous">
                                                <span aria-hidden="true">&laquo; Previous</span>
                                            </a>
                                        </li>
                                    {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link">&laquo; Previous</span>
                                        </li>
                                    {% endif %}

                                    <!-- Page Numbers Info -->
                                    <li class="page-item active">
                                    <span class="page-link">
                                        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                                    </span>
                                    </li>

                                    <!-- Next Page -->
                                    {% if page_obj.has_next %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page=
                                                    {{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                                               aria-label="Next">
                                                <span aria-hidden="true">Next &raquo;</span>
                                            </a>
                                        </li>
                                    {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link">Next &raquo;</span>
                                        </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        {% endif %}

                    </div>
                </div>

            </div>
        </div>
    </section>

</main>

<style>
    .accordion-button:not(.collapsed) {
        color: #0d6efd;
        background-color: #e7f1ff;
        box-shadow: inset 0 -1px 0 rgba(0, 0, 0, .125);
    }

    .accordion-button:focus {
        box-shadow: none;
        border-color: rgba(0, 0, 0, .125);
    }

    .x-small {
        font-size: 0.75rem;
    }
    .table thead th {
        font-size: 13px;
        color: #444;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .table tbody td {
        font-size: 14px;
        vertical-align: middle;
    }

    /* Simple hover effect for whatsapp button */
    .btn-outline-success:hover {
        background-color: #25D366;
        color: white;
        border-color: #25D366;
    }
</style>

    <!-- SCRIPT FOR WHATSAPP LOGIC -->
    <script>
        function sendWhatsApp(phone, name, fileNumber) {
            if (!phone) {
                alert("Phone number is not available for this client.");
                return;
            }

            // 1. Clean the number (remove spaces, dashes, + signs)
            let cleanNumber = phone.replace(/[^\d]/g, '');

            // 2. Logic to handle Country Code (Assuming India +91)
            // If the number is exactly 10 digits, we assume it's missing the country code
            if (cleanNumber.length === 10) {
                cleanNumber = '91' + cleanNumber;
            }
            // If it starts with 0, replace with 91
            else if (cleanNumber.startsWith('0') && cleanNumber.length === 11) {
                cleanNumber = '91' + cleanNumber.substring(1);
            }

            // 3. Construct the Message
            // You can customize this standard greeting
            let greeting = `Hello ${name}`;
            if (fileNumber) {
                greeting += ` (File: ${fileNumber})`;
            }
            let messageBody = `${greeting}, \n\nWe are reaching out from the office regarding your recent updates. Please let us know if you have any queries.\n\nThank you.`;

            // 4. Encode URL
            // https://wa.me/ is the official API-free endpoint
            let url = `https://wa.me/${cleanNumber}?text=${encodeURIComponent(messageBody)}`;

            // 5. Open in New Tab
            window.open(url, '_blank');
        }

        // GST Number Detection and Validation
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            const searchHint = document.getElementById('searchHint');
            
            // GST number pattern: 15 characters - 2 digits, 5 letters, 4 digits, 1 letter, 1 alphanumeric, Z, 1 alphanumeric
            const gstPattern = /^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$/;
            
            function validateGSTNumber(gstNumber) {
                // Remove spaces and convert to uppercase
                const cleanGST = gstNumber.replace(/\s/g, '').toUpperCase();
                return gstPattern.test(cleanGST);
            }
            
            function updateSearchHint(inputValue) {
                const cleanInput = inputValue.replace(/\s/g, '').toUpperCase();
                
                if (cleanInput.length === 0) {
                    searchHint.innerHTML = 'ðŸ’¡ Tip: Enter GST number (15-digit format) for GST search';
                    searchHint.className = 'form-text x-small';
                    searchInput.className = 'form-control';
                } else if (cleanInput.length === 15) {
                    if (validateGSTNumber(cleanInput)) {
                        searchHint.innerHTML = 'âœ… Valid GST number detected - will search GST records';
                        searchHint.className = 'form-text x-small text-success';
                        searchInput.className = 'form-control border-success';
                    } else {
                        searchHint.innerHTML = 'âŒ Invalid GST number format';
                        searchHint.className = 'form-text x-small text-danger';
                        searchInput.className = 'form-control border-danger';
                    }
                } else if (cleanInput.length > 10 && cleanInput.length < 15) {
                    // Partial GST number
                    searchHint.innerHTML = `ðŸ” GST format: ${cleanInput.length}/15 characters entered`;
                    searchHint.className = 'form-text x-small text-info';
                    searchInput.className = 'form-control border-info';
                } else {
                    // Regular search
                    searchHint.innerHTML = 'ðŸ” Searching by name, PAN, or file number';
                    searchHint.className = 'form-text x-small text-muted';
                    searchInput.className = 'form-control';
                }
            }
            
            // Real-time validation as user types
            searchInput.addEventListener('input', function() {
                updateSearchHint(this.value);
            });
            
            // Initialize hint on page load if there's a value
            if (searchInput.value) {
                updateSearchHint(searchInput.value);
            }
            
            // Format GST number input (add spaces for readability)
            searchInput.addEventListener('blur', function() {
                const value = this.value.replace(/\s/g, '').toUpperCase();
                if (value.length === 15 && validateGSTNumber(value)) {
                    // Format as: 12ABCDE1234F1Z5
                    // Display as: 12 ABCDE 1234 F1Z5 (for readability)
                    const formatted = value.replace(/^(.{2})(.{5})(.{4})(.{4})$/, '$1 $2 $3 $4');
                    this.value = formatted;
                }
            });
            
            // Remove formatting on focus for easier editing
            searchInput.addEventListener('focus', function() {
                this.value = this.value.replace(/\s/g, '');
            });
        });
    </script>

{% endblock body %}