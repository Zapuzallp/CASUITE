{% extends 'base.html' %}
{% load static %}

{% block body %}
<style>
    label.required::after {
        content: " *";
        color: red;
    }
</style>

<main id="main" class="main">
    <!-- Breadcrumb -->
    <div class="pagetitle">
        <h1>Add New Task</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'client_dashboard' %}">Home</a></li>
                <li class="breadcrumb-item"><a href="{% url 'client_details' pk=client.id %}">{{ client.client_name }}</a></li>
                <li class="breadcrumb-item active">Add Task</li>
            </ol>
        </nav>
    </div>

    <section class="section">
        <div class="container-fluid">
            <!-- Client Details -->
            <div class="card mb-4 shadow border-0">
                <div class="card-header bg-primary text-white d-flex align-items-center">
                    <i class="bi bi-person-badge fs-4 me-2"></i>
                    <span class="fs-5 fw-bold">Client Details</span>
                </div>
                <div class="card-body py-3">
                    <div class="row g-4 align-items-center">
                        <div class="col-md-3 text-center">
                            <div class="bg-light rounded-circle mx-auto mb-2" style="width:60px;height:60px;display:flex;align-items:center;justify-content:center;">
                                <i class="bi bi-person-circle text-primary" style="font-size:2.5rem;"></i>
                            </div>
                            <div class="fw-bold fs-6">{{ client.client_name }}</div>
                            <div class="small text-muted">Client Name</div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="d-flex flex-column align-items-center">
                                <i class="bi bi-credit-card-2-front text-info mb-1" style="font-size:1.2rem;"></i>
                                <div class="fw-semibold fs-6">{{ client.pan_no|default:"-" }}</div>
                                <div class="small text-muted">PAN</div>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="d-flex flex-column align-items-center">
                                <i class="bi bi-envelope-at text-warning mb-1" style="font-size:1.2rem;"></i>
                                <div class="fw-semibold fs-6">{{ client.email|default:"-" }}</div>
                                <div class="small text-muted">Email</div>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="d-flex flex-column align-items-center">
                                <i class="bi bi-telephone text-success mb-1" style="font-size:1.2rem;"></i>
                                <div class="fw-semibold fs-6">{{ client.phone|default:"-" }}</div>
                                <div class="small text-muted">Phone</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step Progress Bar -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between flex-wrap">
                        <div class="flex-grow-1">
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-success" role="progressbar" style="width: {% if stage == 1 %}50{% elif stage == 2 %}100{% else %}0{% endif %}%" aria-valuenow="{% if stage == 1 %}50{% elif stage == 2 %}100{% else %}0{% endif %}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>
                        <div class="ms-3 small fw-semibold">
                            Step {{ stage }} of 2
                        </div>
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                        <span class="small {% if stage == 1 %}text-success fw-bold{% endif %}">Select Task Type &amp; Related Service</span>
                        <span class="small {% if stage == 2 %}text-success fw-bold{% endif %}">Enter Task Details</span>
                    </div>
                </div>
            </div>

            <!-- Main Form Full Width -->
            <div class="card shadow-sm border-0 mb-4 w-100">
                <div class="card-header bg-success text-white py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold">
                            <i class="bi bi-plus-circle me-2"></i>Create New Task
                        </h5>
                        <a href="{% url 'client_details' pk=client.id %}" class="btn btn-outline-light btn-sm">
                            <i class="bi bi-arrow-left me-1"></i>Back to Client
                        </a>
                    </div>
                </div>
                <div class="card-body p-4">
                    {% if stage == 1 %}
                    <form method="get">
                        <div class="row g-4">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Task Type <span class="text-danger">*</span></label>
                                <select name="service_type" id="id_service_type" class="form-select" required>
                                    <option value="">Select Task Type</option>
                                    {% for st in task_service_types %}
                                    <option value="{{ st.id }}" data-name="{{ st.service_name }}">
                                        {{ st.service_name}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Related Service <span class="text-danger">*</span></label>
                                <select name="client_service" id="id_client_service" class="form-select" required>
                                    <option value="">Select Service</option>
                                    {% for cs in client_services_for_tasks %}
                                    <option value="{{ cs.id }}" data-service-name="{{ cs.service.service_name }}">
                                        {{ cs.service.service_name }} ({{ cs.start_date }}{% if cs.end_date %} -
                                        {{cs.end_date }}{% endif %}, {{ cs.get_billing_cycle_display }}, Fee:
                                        {{cs.agreed_fee }})
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end mt-4 gap-2">
                            <a href="{% url 'client_details' pk=client.id %}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle me-1"></i>Cancel
                            </a>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-arrow-right me-1"></i>Next
                            </button>
                        </div>
                    </form>
                    {% else %}
                    <div class="mb-4">
                        <h6 class="fw-bold mb-2 text-primary">
                            <i class="bi bi-info-circle me-2"></i>Selected Task Type &amp; Service
                        </h6>
                        <p class="mb-1">
                            <strong>Task Type:</strong> {{ selected_service_type.service_name }}<br>
                            <strong>Service:</strong> {{ selected_client_service.service.service_name }}
                            ({{ selected_client_service.start_date }}{% if selected_client_service.end_date %} -
                            {{selected_client_service.end_date }}{% endif %},
                            {{ selected_client_service.get_billing_cycle_display }},
                            Fee: {{ selected_client_service.agreed_fee }})
                        </p>
                    </div>

                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" name="service_type" value="{{ selected_service_type.id }}">
                        <input type="hidden" name="client_service" value="{{ selected_client_service.id }}">

                        <div class="row g-4">
                            <div class="col-12">
                                <h6 class="fw-bold mb-3 text-primary">
                                    <i class="bi bi-card-checklist me-2"></i>Task Details
                                </h6>
                            </div>

                            <div class="col-12">
                                {{ task_form.task_title.label_tag }}
                                {{ task_form.task_title }}
                            </div>

                            <div class="col-md-6">
                                {{ task_form.period_from.label_tag }}
                                {{ task_form.period_from }}
                            </div>
                            <div class="col-md-6">
                                {{ task_form.period_to.label_tag }}
                                {{ task_form.period_to }}
                            </div>

                            <div class="col-md-6">
                                {{ task_form.due_date.label_tag }}
                                {{ task_form.due_date }}
                            </div>
                            <div class="col-md-6">
                                {{ task_form.assigned_to.label_tag }}
                                {{ task_form.assigned_to }}
                            </div>

                            <div class="col-md-6">
                                {{ task_form.recurrence.label_tag }}
                                {{ task_form.recurrence }}
                            </div>
                            <div class="col-md-6">
                                {{ task_form.document_link.label_tag }}
                                {{ task_form.document_link }}
                            </div>

                            <div class="col-12">
                                {{ task_form.remarks.label_tag }}
                                {{ task_form.remarks }}
                            </div>

                            {% if details_form %}
                            <div class="col-12">
                                <hr>
                                <h6 class="fw-bold mb-3 text-primary">
                                    <i class="bi bi-file-earmark-text me-2"></i>Case / Service Details
                                </h6>
                                {{ details_form.as_p }}
                            </div>
                            {% endif %}
                        </div>

                        <div class="d-flex justify-content-end mt-4 gap-2">
                            <a href="{% url 'add_task' client.id %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-1"></i>Back
                            </a>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-check-lg me-1"></i>Create Task
                            </button>
                        </div>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true"
        data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="successModalLabel"><i class="bi bi-check-circle-fill me-2"></i>Success
                    </h5>
                </div>
                <div class="modal-body text-center py-4">
                    <i class="bi bi-check-circle text-success display-1 mb-3"></i>
                    <h4 class="fw-bold">Task Created Successfully!</h4>
                    <p class="text-muted">The task <strong>"{{ created_task_title }}"</strong> has been created.</p>
                </div>
                <div class="modal-footer justify-content-center">
                    <a href="{% url 'client_details' pk=client.id %}" class="btn btn-success px-4">OK</a>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // 1. Dynamic Service Filtering
        const taskTypeSelect = document.getElementById('id_service_type');
        const serviceSelect = document.getElementById('id_client_service');

        if (taskTypeSelect && serviceSelect) {
            const allServiceOptions = Array.from(serviceSelect.options);

            taskTypeSelect.addEventListener('change', function () {
                const selectedOption = this.options[this.selectedIndex];
                const taskTypeName = selectedOption.getAttribute('data-name');

                // Reset service selection
                serviceSelect.value = "";

                // Filter options
                allServiceOptions.forEach(option => {
                    if (option.value === "") return; // Skip placeholder

                    const serviceName = option.getAttribute('data-service-name');
                    let shouldShow = true;

                    if (taskTypeName) {
                        if (taskTypeName.includes('GST Case')) {
                            shouldShow = serviceName.includes('GST');
                        } else if (taskTypeName.includes('Income Tax Case')) {
                            shouldShow = serviceName.includes('ITR') || serviceName.includes('Audit');
                        }
                    }

                    if (shouldShow) {
                        option.style.display = '';
                        option.hidden = false;
                    } else {
                        option.style.display = 'none';
                        option.hidden = true;
                    }
                });
            });
        }

        // 2. Success Modal
        {% if success %}
        var successModal = new bootstrap.Modal(document.getElementById('successModal'));
        successModal.show();
        {% endif %}

        // 3. Auto-calculate Due Date when period dates change
        const periodFromInput = document.getElementById('id_period_from');
        const periodToInput = document.getElementById('id_period_to');
        const dueDateInput = document.getElementById('id_due_date');
        const dueDays = {{ due_days_meta|default:0 }};
        const frequency = '{{ frequency|default:"Monthly" }}';

        function updateDueDate() {
            if (!periodToInput || !dueDateInput || dueDays <= 0) return;

            const periodToDate = new Date(periodToInput.value);
            if (isNaN(periodToDate.getTime())) return;

            // Calculate due date by adding default_due_days to period_to
            const dueDate = new Date(periodToDate);
            dueDate.setDate(dueDate.getDate() + parseInt(dueDays));

            // Update the due date field
            dueDateInput.value = dueDate.toISOString().split('T')[0];
        }

        // Set up event listeners
        if (periodToInput && dueDateInput) {
            periodToInput.addEventListener('change', updateDueDate);

            // Also update when period_from changes to maintain consistency
            if (periodFromInput) {
                periodFromInput.addEventListener('change', function() {
                    const fromDate = new Date(this.value);
                    if (isNaN(fromDate.getTime())) return;

                    // If period_to is empty or before the new from date, update it
                    const toDate = periodToInput.value ? new Date(periodToInput.value) : null;
                    if (!toDate || isNaN(toDate.getTime()) || toDate < fromDate) {
                        const newToDate = new Date(fromDate);
                        if (frequency === 'Monthly') {
                            newToDate.setMonth(newToDate.getMonth() + 1);
                            newToDate.setDate(0); // Last day of the month
                        } else if (frequency === 'Quarterly') {
                            newToDate.setMonth(newToDate.getMonth() + 3);
                            newToDate.setDate(0);
                        } else if (frequency === 'Yearly') {
                            newToDate.setFullYear(newToDate.getFullYear() + 1);
                            newToDate.setDate(0);
                        } else {
                            // Default to 1 month
                            newToDate.setMonth(newToDate.getMonth() + 1);
                            newToDate.setDate(0);
                        }

                        periodToInput.value = newToDate.toISOString().split('T')[0];
                        updateDueDate();
                    }
                });
            }

            // Initial calculation if period_to is already filled
            if (periodToInput.value) {
                updateDueDate();
            }
        }

        // 4. Live Validation
        const inputs = document.querySelectorAll('input, select, textarea');

        inputs.forEach(input => {
            input.addEventListener('input', function () {
                validateField(this);
            });
            input.addEventListener('blur', function () {
                validateField(this);
            });
        });

        function validateField(field) {
            if (field.checkValidity()) {
                field.classList.remove('is-invalid');
                field.classList.add('is-valid');
            } else {
                field.classList.remove('is-valid');
                field.classList.add('is-invalid');
            }
        }
    });
</script>
{% endblock %}