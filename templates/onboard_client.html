{% extends 'base.html' %}
{% block body %}

<main id="main" class="main">

{% if messages %}
<div class="container mt-3">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="container mt-4">

<h2 class="mb-4 text-primary fw-bold">
    {{ page_title|default:"Onboard New Client" }}
</h2>

<form method="post" enctype="multipart/form-data" id="onboardingForm" novalidate>
{% csrf_token %}

<!-- ================= BASIC INFORMATION ================= -->
<div class="card mb-4 shadow-sm border-0">
    <div class="card-header bg-primary text-white d-flex justify-content-between">
        <span>Basic Information</span>
        {% if client_form.instance.pk %}
        <span class="badge bg-light text-primary">
            File No: {{ client_form.instance.file_number|default:"Generating..." }}
        </span>
        {% endif %}
    </div>

    <div class="card-body p-4">
        <div class="row" id="clientFieldsContainer">
            {% for field in client_form %}
            <div class="col-md-6 mb-3 field-wrapper client-field-wrapper"
                 data-field-name="{{ field.name }}">

                <label class="form-label fw-bold" id="label_{{ field.name }}">
                    {{ field.label }}
                    {% if field.field.required %}
                        <span class="text-danger">*</span>
                    {% endif %}
                </label>

                {{ field }}

                {% if field.errors %}
                    <div class="text-danger small">{{ field.errors.0 }}</div>
                {% endif %}

                {% if field.help_text %}
                    <div class="form-text small text-muted">{{ field.help_text }}</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- ================= ENTITY / PROFILE DETAILS ================= -->
<div class="card mb-4 shadow-sm border-0" id="businessProfileSection">
    <div class="card-header bg-secondary text-white">
        <span id="profileHeader">Entity Details</span>
    </div>

    <div class="card-body p-4">
        <div class="row" id="profileFieldsContainer">
            {% for field in profile_form %}
            <div class="col-md-6 mb-3 field-wrapper profile-field-wrapper"
                 data-field-name="{{ field.name }}">

                <label class="form-label fw-bold" id="label_{{ field.name }}">
                    {{ field.label }}
                </label>

                {{ field }}

                {% if field.errors %}
                    <div class="text-danger small">{{ field.errors.0 }}</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<div class="d-flex justify-content-between">
    <a href="{% url 'clients' %}" class="btn btn-outline-secondary">Cancel</a>
    <button type="submit" class="btn btn-success btn-lg px-5">
        {{ btn_text|default:"Complete Onboarding" }}
    </button>
</div>

</form>
</div>
</main>

{{ structure_config|json_script:"structure-config-data" }}

<!-- ================= JS ================= -->

<script>
(function () {

function loadJquery(cb) {
    if (typeof jQuery === "undefined") {
        const jq = document.createElement("script");
        jq.src = "https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js";
        jq.onload = cb;
        document.head.appendChild(jq);
    } else cb();
}

function loadSelect2(cb) {
    if (!$.fn.select2) {
        const s = document.createElement("script");
        s.src = "https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js";
        s.onload = cb;
        document.head.appendChild(s);
    } else cb();
}

function initSelect2(context = document) {
    $(context).find('.select2-multiple').each(function () {
        this.classList.remove('form-control');
        $(this).select2({
            theme: 'bootstrap-5',
            width: '100%',
            placeholder: $(this).data('placeholder') || 'Select options',
            allowClear: true,
            closeOnSelect: false
        });
    });
}

/* ================= VISIBILITY LOGIC ================= */

function initializeForm() {
    initSelect2();

    const clientTypeSelect = document.getElementById('id_client_type');
    const structureSelect = document.getElementById('id_business_structure');
    const profileSection = document.getElementById('businessProfileSection');
    const profileHeader = document.getElementById('profileHeader');

    const clientDOMFields = [...document.querySelectorAll('.client-field-wrapper')];
    const profileDOMFields = [...document.querySelectorAll('.profile-field-wrapper')];

    const getFieldNames = list => list.map(el => el.dataset.fieldName);

    let configData = {};
    try {
        configData = JSON.parse(
            document.getElementById("structure-config-data").textContent
        );
    } catch (e) { console.error(e); }

    function calculateFinalList(all, rules) {
        if (!rules) return [];
        let list = rules.include?.length ? [...rules.include] : [...all];
        return list.filter(f => !rules.exclude?.includes(f));
    }

    function updateFormVisibility() {
    const cType = clientTypeSelect?.value || '';
    const sType = structureSelect?.value || '';

    // Default: hide entity details
    profileSection.style.display = 'none';

    // Reset profile fields visibility
    profileDOMFields.forEach(w => {
        w.style.display = 'none';
    });


    if (cType !== 'Entity') {
        return;
    }


    if (!sType || !configData[sType]) {
        return;
    }

    // Entity + Structure selected â†’ show entity section
    const cfg = configData[sType];
    const customLabels = cfg.labels || {};

    profileSection.style.display = 'block';
    profileHeader.textContent = `${sType} Details`;

    const profileNames = getFieldNames(profileDOMFields);
    const visibleProfile = calculateFinalList(profileNames, cfg.profile);

    profileDOMFields.forEach(w => {
        const name = w.dataset.fieldName;
        const lbl = document.getElementById(`label_${name}`);

        if (!lbl.dataset.orig) {
            lbl.dataset.orig = lbl.textContent;
        }

        if (visibleProfile.includes(name)) {
            w.style.display = 'block';
            lbl.textContent = customLabels[name] || lbl.dataset.orig;
        } else {
            w.style.display = 'none';
        }
    });
}

    clientTypeSelect?.addEventListener("change", updateFormVisibility);
    structureSelect?.addEventListener("change", updateFormVisibility);
    updateFormVisibility();
}

document.addEventListener("DOMContentLoaded", () => {
    loadJquery(() => loadSelect2(initializeForm));
});

})();
</script>

{% endblock %}
