{% extends "base.html" %}
{% load humanize %}
{% load static %}

{% block body %}
<!-- CUSTOM STYLES MOVED HERE SO THEY LOAD CORRECTLY -->
<style>
  /* --- FORCE OVERRIDE FOR CHIPS (PILL) STYLING --- */

  /* 1. The Container for the selected items */
  .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__rendered {
    display: flex !important;
    flex-wrap: wrap !important;
    gap: 4px !important;
    padding: 4px !important;
  }

  /* 2. The Chip Itself (White Pill with Grey Border) */
  .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice {
    width: auto !important;
    display: inline-flex !important;
    align-items: center !important;
    flex-direction: row-reverse !important; /* Move X to the right */

    background-color: #fff !important;
    border: 1px solid #ced4da !important;
    color: #495057 !important;

    border-radius: 50px !important; /* Fully rounded pill */
    padding: 2px 8px 2px 12px !important; /* Padding for text */
    margin: 2px !important;
    font-size: 0.85rem !important;
    font-weight: 500 !important;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  }

  /* 3. The "X" Remove Button inside the Chip */
  .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice__remove {
    border: none !important;
    background: #e9ecef !important; /* Light grey circle */
    color: transparent !important; /* Hide default text color */

    /* Circle dimensions */
    width: 18px !important;
    height: 18px !important;
    min-width: 18px !important;
    min-height: 18px !important;
    border-radius: 50% !important;

    /* Flexbox centering */
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;

    margin-left: 8px !important;
    margin-right: 0 !important;
    padding: 0 !important;

    font-size: 0 !important; /* Hide default text */
    line-height: 1 !important;
    transition: all 0.2s ease;
    position: relative !important;
    overflow: hidden !important;
    vertical-align: middle !important;
  }

  /* Hide any child elements that Select2 might add */
  .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice__remove > * {
    display: none !important;
  }

  /* Add X icon using ::after for better control */
  .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice__remove::after {
    content: "×" !important;
    color: #6c757d !important;
    font-size: 14px !important;
    font-weight: bold !important;
    line-height: 1 !important;

    /* Absolute positioning to fill the circle */
    position: absolute !important;
    top: 0 !important;
    left: -7px !important; /* Move slightly to the left */
    width: 100% !important;
    height: 100% !important;

    /* Center the × */
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }

  /* Hover Effect */
  .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice__remove:hover {
    background-color: #dc3545 !important;
    transform: scale(1.1);
  }

  .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice__remove:hover::after {
    color: white !important;
  }

  /* --- DROPDOWN CHECKBOX STYLING (FOR MULTI-SELECT ONLY) --- */
  .select2-container--bootstrap-5 .select2-dropdown {
    border-color: #dee2e6;
    border-radius: 0 0 12px 12px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    padding-top: 0 !important;
    overflow: hidden;
  }

  /* Dropdown Options */
  .select2-container--bootstrap-5 .select2-results__option {
    padding: 8px 15px !important;
    position: relative;
    font-size: 0.9rem;
    color: #333;
    background-color: #fff;
    transition: all 0.2s ease;
  }

  /* Hover State - Clean highlight without checkbox */
  .select2-container--bootstrap-5 .select2-results__option--highlighted {
    background-color: #0d6efd !important;
    color: #fff !important;
  }

  /* Selected State - Subtle background */
  .select2-container--bootstrap-5 .select2-results__option[aria-selected="true"] {
    background-color: #e7f3ff !important;
    color: #0d6efd !important;
    font-weight: 500;
  }

  /* Remove checkbox styling for single-select dropdowns */
  .select2-container--bootstrap-5 .select2-results__option::before,
  .select2-container--bootstrap-5 .select2-results__option::after {
    display: none !important;
  }

  /* Only show checkboxes for multi-select (services field) */
  #select2-id_services-results .select2-results__option {
    padding-left: 38px !important;
  }

  #select2-id_services-results .select2-results__option::before {
    content: '';
    display: block !important;
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    width: 16px;
    height: 16px;
    border: 1px solid #adb5bd;
    border-radius: 3px;
    background-color: #fff;
    transition: all 0.2s;
  }

  #select2-id_services-results .select2-results__option[aria-selected="true"]::before {
    background-color: #0d6efd;
    border-color: #0d6efd;
  }

  #select2-id_services-results .select2-results__option[aria-selected="true"]::after {
    content: '';
    display: block !important;
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-60%) rotate(45deg);
    width: 5px;
    height: 9px;
    border-bottom: 2px solid white;
    border-right: 2px solid white;
  }

  /* --- SELECT ALL BUTTON --- */
  .select-all-container {
      padding: 10px 15px;
      border-bottom: 1px solid #eee;
      background-color: #fff;
      position: sticky;
      top: 0;
      z-index: 9999;
      display: flex;
      align-items: center;
      cursor: pointer;
  }

  .select-all-container:hover {
      background-color: #f8f9fa;
  }

  .select-all-checkbox {
      width: 16px;
      height: 16px;
      margin-right: 10px;
      accent-color: #0d6efd;
      cursor: pointer;
  }

  .select-all-label {
      font-weight: 600;
      font-size: 0.9rem;
      color: #0d6efd;
      cursor: pointer;
      margin-bottom: 0;
      user-select: none;
  }

  /* Hide default helper text under multiselect to clean UI */
  .card-multiselect-container .text-muted.fst-italic {
    display: none;
  }

  .card-multiselect-container {
    padding: 0;
    border: none;
  }
</style>

<main id="main" class="main">
  <div class="pagetitle">
    <h1>Invoices</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Home</a></li>
        <li class="breadcrumb-item active">Invoices</li>
      </ol>
    </nav>
  </div>

  <section class="section">
    <div class="row">
      <div class="col-lg-12">

        <div class="card shadow-sm border-0">
          <div class="card-body">

            <div class="d-flex justify-content-between align-items-center my-3">
              <div>
                <h5 class="card-title m-0">All Invoices</h5>
                <small class="text-muted">Showing {{ invoices|length}} invoice(s)</small>
              </div>
              {% if not is_partner %}
              <div>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addInvoiceModal">
                  <i class="bi bi-plus-circle me-1"></i> Add Invoice
                </button>
              </div>
              {% endif %}
            </div>

            {% if messages %}
              {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                  <i class="bi bi-info-circle me-1"></i> {{ message }}
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
              {% endfor %}
            {% endif %}

            <!-- ACCORDION FILTER SECTION -->
            <div class="accordion mb-4" id="invoiceFilterAccordion">
              <div class="accordion-item border-0 shadow-sm">
                <h2 class="accordion-header" id="headingOne">
                  <button class="accordion-button {% if not filters.client and not filters.status and not filters.date_from and not filters.date_to and not filters.search %}collapsed{% endif %} bg-white text-primary fw-bold"
                          type="button"
                          data-bs-toggle="collapse"
                          data-bs-target="#collapseFilter"
                          aria-expanded="{% if filters.client or filters.status or filters.date_from or filters.date_to or filters.search %}true{% else %}false{% endif %}"
                          aria-controls="collapseFilter">
                    <i class="bi bi-funnel-fill me-2"></i> Filters
                  </button>
                </h2>
                <div id="collapseFilter"
                     class="accordion-collapse collapse {% if filters.client or filters.status or filters.date_from or filters.date_to or filters.search %}show{% endif %}"
                     aria-labelledby="headingOne"
                     data-bs-parent="#invoiceFilterAccordion">
                  <div class="accordion-body bg-light">
                    <form method="get" id="filterForm">
                      <div class="row g-3">
                        <div class="col-md-3">
                          <label class="form-label small fw-bold text-secondary">Client</label>
                          <select name="client" class="form-select">
                            <option value="">All Clients</option>
                            {% for client in clients %}
                              <option value="{{ client.id }}" {% if filters.client == client.id|stringformat:"s" %}selected{% endif %}>
                                {{ client.client_name }}
                              </option>
                            {% endfor %}
                          </select>
                        </div>
                        <div class="col-md-2">
                          <label class="form-label small fw-bold text-secondary">Payment Status</label>
                          <select name="payment_status" class="form-select">
                            <option value="">All</option>
                            <option value="DRAFT" {% if filters.payment_status == 'DRAFT' %}selected{% endif %}>Draft</option>
                            <option value="OPEN" {% if filters.payment_status == 'OPEN' %}selected{% endif %}>Open</option>
                            <option value="PARTIALLY_PAID" {% if filters.payment_status == 'PARTIALLY_PAID' %}selected{% endif %}>Partially Paid</option>
                            <option value="PAID" {% if filters.payment_status == 'PAID' %}selected{% endif %}>Paid</option>
                          </select>
                        </div>
                        <div class="col-md-2">
                          <label class="form-label small fw-bold text-secondary">Due Status</label>
                          <select name="due_status" class="form-select">
                            <option value="">All</option>
                            <option value="not_due" {% if filters.due_status == 'not_due' %}selected{% endif %}>Not Due</option>
                            <option value="due_today" {% if filters.due_status == 'due_today' %}selected{% endif %}>Due Today</option>
                            <option value="overdue" {% if filters.due_status == 'overdue' %}selected{% endif %}>Overdue</option>
                          </select>
                        </div>
                        <div class="col-md-2">
                          <label class="form-label small fw-bold text-secondary">Date From</label>
                          <input type="date" name="date_from" value="{{ filters.date_from }}" class="form-control">
                        </div>
                        <div class="col-md-2">
                          <label class="form-label small fw-bold text-secondary">Date To</label>
                          <input type="date" name="date_to" value="{{ filters.date_to }}" class="form-control">
                        </div>
                        <div class="col-md-3">
                          <label class="form-label small fw-bold text-secondary">Search</label>
                          <input type="text" name="search" value="{{ filters.search }}" placeholder="Invoice ID or Subject..." class="form-control">
                        </div>
                        <div class="col-md-12 d-flex justify-content-end">
                          <button type="submit" class="btn btn-primary me-2">
                            <i class="bi bi-search"></i> Apply Filters
                          </button>
                          <a href="{% url 'invoice_list' %}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Clear
                          </a>
                        </div>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>

            <form method="post" action="{% url 'invoice_bulk_status_update' %}" id="bulkStatusForm">
              {% csrf_token %}
              <div class="table-responsive">
                <table id="invoicesTable" class="table table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>Invoice #</th>
                      <th>Client</th>
                      <th>Subject</th>
                      <th>Invoice Date</th>
                      <th>Due Date</th>
                      <th>Total Amount</th>
                      <th>Paid</th>
                      <th>Balance</th>
                      <th>Payment Status</th>
                      <th>Due Status</th>
                      <th>Action</th>
                    </tr>
                  </thead>

                  <tbody>
                  {% if invoices %}
                    {% for item in invoices %}
                    <tr>
                      <td class="fw-bold">#{{ item.invoice.id }}</td>
                      <td>
                        <a href="{% url 'client_details' item.invoice.client.id %}" class="text-decoration-none">
                          {{ item.invoice.client.client_name }}
                        </a>
                      </td>
                      <td>{{ item.invoice.subject|truncatewords:5 }}</td>
                      <td>{{ item.invoice.invoice_date|date:"M d, Y" }}</td>
                      <td>{{ item.invoice.due_date|date:"M d, Y" }}</td>
                      <td>₹{{ item.total_amount|floatformat:0|intcomma }}</td>
                      <td class="text-success">₹{{ item.total_paid|floatformat:2|intcomma }}</td>
                      <td class="{% if item.balance > 0 %}text-warning fw-bold{% else %}text-success{% endif %}">
                        ₹{{ item.balance|floatformat:0|intcomma }}
                      </td>
                      <td>
                        {% if item.has_payments %}
                          <!-- Status locked - payment received - show badge only -->
                          <span class="badge
                            {% if item.payment_status == 'PAID' %}bg-success
                            {% elif item.payment_status == 'PARTIALLY_PAID' %}bg-warning text-dark
                            {% elif item.payment_status == 'OPEN' %}bg-info
                            {% else %}bg-secondary{% endif %}">
                            {{ item.payment_status_display }}
                          </span>
                        {% elif item.payment_status == 'DRAFT' or item.payment_status == 'OPEN' %}
                          <!-- Status editable - no payment yet - show dropdown (unless partner) -->
                          {% if is_partner %}
                            <span class="badge
                              {% if item.payment_status == 'DRAFT' %}bg-secondary
                              {% else %}bg-info{% endif %}">
                              {{ item.payment_status_display }}
                            </span>
                          {% else %}
                            <select name="status_{{ item.invoice.id }}" class="form-select form-select-sm status-dropdown" style="min-width: 120px;">
                              <option value="DRAFT" {% if item.payment_status == 'DRAFT' %}selected{% endif %}>Draft</option>
                              <option value="OPEN" {% if item.payment_status == 'OPEN' %}selected{% endif %}>Open</option>
                            </select>
                          {% endif %}
                        {% else %}
                          <!-- Fallback - show badge -->
                          <span class="badge bg-secondary">
                            {{ item.payment_status_display }}
                          </span>
                        {% endif %}
                      </td>
                      <td>
                        {% if item.due_status %}
                          <span class="badge
                            {% if item.due_status == 'overdue' %}bg-danger
                            {% elif item.due_status == 'due_today' %}bg-warning text-dark
                            {% else %}bg-light text-dark border{% endif %}">
                            {% if item.due_status == 'overdue' %}
                              <i class="bi bi-exclamation-triangle me-1"></i>Overdue
                            {% elif item.due_status == 'due_today' %}
                              <i class="bi bi-clock me-1"></i>Due Today
                            {% else %}
                              <i class="bi bi-check-circle me-1"></i>Not Due
                            {% endif %}
                          </span>
                        {% else %}
                          <span class="text-muted small">—</span>
                        {% endif %}
                      </td>
                      <td>
                        <div class="d-flex gap-1">
                          <a class="btn btn-sm btn-outline-primary"
                             href="{% url 'invoice_details' item.invoice.id %}"
                             title="View Invoice">
                            <i class="bi bi-eye"></i>
                          </a>

                          {% if item.balance > 0 and item.payment_status != 'DRAFT' %}
                            {% if not is_partner %}
                            <a class="btn btn-sm btn-success"
                               href="{% url 'payment_collect' item.invoice.id %}"
                               title="Collect Payment">
                              <i class="bi bi-cash-coin"></i>
                            </a>
                            {% endif %}
                          {% endif %}
                        </div>
                      </td>
                    </tr>
                    {% endfor %}
                  {% else %}
                    <tr>
                      <td colspan="11" class="text-center text-muted py-4">
                        No invoices found.
                      </td>
                    </tr>
                  {% endif %}
                  </tbody>
                </table>
              </div>

              <!-- Save Button at Bottom (Hide for partners) -->
              {% if not is_partner %}
              <div class="d-flex justify-content-end mt-3">
                <button type="submit" class="btn btn-primary px-4" id="saveStatusBtn">
                  <i class="bi bi-check-circle me-1"></i> Save Status Changes
                </button>
              </div>
              {% endif %}
            </form>

          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Add Invoice Modal -->
  <div class="modal fade" id="addInvoiceModal" tabindex="-1" aria-labelledby="addInvoiceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content shadow-lg">
        <div class="modal-header">
          <h5 class="modal-title" id="addInvoiceModalLabel">
            <span class="bg-primary bg-gradient text-white rounded-3 p-2 me-2 shadow-sm"><i class="bi bi-receipt"></i></span>
            Create New Invoice
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <form method="post" action="{% url 'invoice_all' %}" id="invoiceForm">
          {% csrf_token %}
          <div class="modal-body">
            <div class="row g-3">

              <!-- Client Selection (with Select2 search) -->
              <div class="col-md-6">
                <label class="form-label small fw-bold text-secondary mb-1">
                  <i class="bi bi-person-fill me-1"></i>Select Client <span class="text-danger">*</span>
                </label>
                {{ form.client }}
                {% if form.client.errors %}
                  <div class="invalid-feedback d-block">{{ form.client.errors }}</div>
                {% endif %}
              </div>

              <!-- Subject -->
              <div class="col-md-6">
                <div class="form-floating">
                  {{ form.subject }}
                  <label for="{{ form.subject.id_for_label }}">Subject / Description <span class="text-danger">*</span></label>
                  {% if form.subject.errors %}
                    <div class="invalid-feedback d-block">{{ form.subject.errors }}</div>
                  {% endif %}
                </div>
              </div>

              <!-- Invoice Date (Floating Label) -->
              <div class="col-md-6">
                <div class="form-floating">
                  {{ form.invoice_date }}
                  <label for="{{ form.invoice_date.id_for_label }}">Invoice Date <span class="text-danger">*</span></label>
                  {% if form.invoice_date.errors %}
                    <div class="invalid-feedback d-block">{{ form.invoice_date.errors }}</div>
                  {% endif %}
                </div>
              </div>

              <!-- Due Date (Floating Label) -->
              <div class="col-md-6">
                <div class="form-floating">
                  {{ form.due_date }}
                  <label for="{{ form.due_date.id_for_label }}">Due Date <span class="text-danger">*</span></label>
                  {% if form.due_date.errors %}
                    <div class="invalid-feedback d-block">{{ form.due_date.errors }}</div>
                  {% endif %}
                </div>
              </div>

              <!-- Services/Tasks (Multi-Select) -->
              <div class="col-12 mt-4">
                  <label class="form-label small fw-bold text-secondary mb-1">
                      <i class="bi bi-list-check me-1"></i>Add Services / Tasks
                  </label>
                  <div class="card-multiselect-container">
                    <select name="services" id="id_services" class="form-select" multiple>
                        <option value="" disabled>Select a client first to load tasks</option>
                    </select>
                  </div>

                    {% if form.services.errors %}
                      <div class="invalid-feedback d-block mt-2">
                        <i class="bi bi-exclamation-circle me-1"></i>{{ form.services.errors }}
                      </div>
                    {% endif %}
              </div>

            </div>
          </div>
          <div class="modal-footer bg-light">
            <button type="button" class="btn btn-outline-secondary border-0" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary px-4 shadow-sm">
              <i class="bi bi-check-lg me-1"></i> Create Invoice
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</main>

<!-- We use a local jQuery here to ensure $ is available for the script below.
     Even if base.html has one, this ensures execution context is correct for this block. -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<!-- We do NOT load Select2 JS/CSS here again because base.html already has them -->

<script>
$(document).ready(function() {
  // Only initialize DataTables if there are rows in the table
  if ($('#invoicesTable tbody tr').length > 0 && !$('#invoicesTable tbody tr td[colspan]').length) {
    $('#invoicesTable').DataTable({
      "pageLength": 25,
      "order": [[0, "desc"]],
      "language": {
        "search": "",
        "searchPlaceholder": "Search invoices...",
        "paginate": { "first": "«", "last": "»", "next": "›", "previous": "‹" }
      },
      "columnDefs": [
        { "orderable": false, "targets": [10] }
      ]
    });
  }

  // Apply Bootstrap classes
  $('#id_subject, #id_invoice_date, #id_due_date').addClass('form-control');

  // Initialize Select2 for Client dropdown with search
  $('#id_client').select2({
    theme: 'bootstrap-5',
    placeholder: 'Search and select client...',
    allowClear: true,
    dropdownParent: $('#addInvoiceModal'),
    width: '100%',
    matcher: function(params, data) {
      // If there are no search terms, return all data
      if ($.trim(params.term) === '') {
        return data;
      }

      // Do not display the item if there is no 'text' property
      if (typeof data.text === 'undefined') {
        return null;
      }

      // `params.term` is the user's search term
      // `data.text` is the text that is displayed for the data object
      if (data.text.toLowerCase().indexOf(params.term.toLowerCase()) > -1) {
        return data;
      }

      // Return `null` if the term should not be displayed
      return null;
    }
  });

  // Initialize Select2 for Services with Bootstrap 5 theme
  var servicesSelect = $('#id_services').select2({
    theme: 'bootstrap-5',
    placeholder: 'Select tasks...',
    allowClear: true,
    dropdownParent: $('#addInvoiceModal'),
    width: '100%',
    closeOnSelect: false,
  });

  // --- "SELECT ALL" LOGIC ---
  // Inject "Select All" checkbox when dropdown opens
  $('#id_services').on('select2:open', function (e) {
      if ($('.select2-results__options .select-all-container').length > 0) return;

      let selectAllHtml = `
          <div class="select-all-container">
             <input type="checkbox" class="select-all-checkbox" id="selectAllCheckbox">
             <label for="selectAllCheckbox" class="select-all-label">Select All</label>
          </div>
      `;
      $('.select2-results__options').prepend(selectAllHtml);
      syncSelectAllCheckbox();
  });

  // Handle "Select All" click
  $(document).on('change', '#selectAllCheckbox', function() {
      var isChecked = $(this).is(':checked');
      if(isChecked) {
          $('#id_services > option:not([disabled])').prop("selected", true);
      } else {
          $('#id_services > option').prop("selected", false);
      }
      $('#id_services').trigger("change");
  });

  // Sync "Select All" checkbox state
  $('#id_services').on('change', function() {
      syncSelectAllCheckbox();
  });

  function syncSelectAllCheckbox() {
      var totalOptions = $('#id_services option:not([disabled])').length;
      var selectedOptions = $('#id_services option:selected:not([disabled])').length;
      var selectAllCb = $('#selectAllCheckbox');

      if (selectAllCb.length) {
          if (totalOptions > 0 && totalOptions === selectedOptions) {
              selectAllCb.prop('checked', true);
          } else {
              selectAllCb.prop('checked', false);
          }
      }
  }

  // AJAX to load tasks
  $('#id_client').on('change', function() {
    var clientId = $(this).val();
    var servicesField = $('#id_services');

    console.log('Client changed:', clientId); // Debug log

    if (clientId) {
      servicesField.next('.select2-container').find('.select2-selection').css('opacity', '0.6');

      $.ajax({
        url: '{% url "load_tasks" %}',
        data: { 'client': clientId },
        dataType: 'json',
        beforeSend: function() {
          console.log('Loading tasks for client:', clientId); // Debug log
          servicesField.prop('disabled', true);
          servicesField.empty().append('<option value="">Loading tasks...</option>');
          servicesField.trigger('change');
        },
        success: function(data) {
          console.log('Tasks loaded:', data); // Debug log
          servicesField.empty();
          if (!data || data.length === 0) {
            servicesField.append(new Option("No available tasks for this client", "", false, false));
          } else {
            $.each(data, function(index, task) {
              var newOption = new Option(task.task_title, task.id, false, false);
              servicesField.append(newOption);
            });
          }
          servicesField.prop('disabled', false);
          servicesField.next('.select2-container').find('.select2-selection').css('opacity', '1');
          servicesField.trigger('change');
        },
        error: function(xhr, status, error) {
          console.error('Error loading tasks:', error, xhr.responseText); // Debug log
          servicesField.empty().append('<option value="">Error loading tasks</option>');
          servicesField.prop('disabled', false);
          servicesField.next('.select2-container').find('.select2-selection').css('opacity', '1');
          servicesField.trigger('change');
        }
      });
    } else {
      servicesField.empty().append('<option value="">Select a client first</option>');
      servicesField.prop('disabled', true);
      servicesField.trigger('change');
    }
  });

  // Reset modal on close
  $('#addInvoiceModal').on('hidden.bs.modal', function () {
    $('#invoiceForm')[0].reset();
    $('#id_services').empty().append('<option value="">Select a client first to load tasks</option>');
    $('#id_services').trigger('change');
  });
});
</script>

{% endblock body %}