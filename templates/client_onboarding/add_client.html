{% extends 'base.html' %}
{% load static %}

{% block body %}
<main id="main" class="main">
    {% if messages %}
        {% for message in messages %}
            {% if message.tags == 'error' or message.tags == 'warning' %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle-fill"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}
        {% endfor %}
    {% endif %}

    <div class="pagetitle">
        <h1>Onboard New Client</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Home</a></li>
                <li class="breadcrumb-item"><a href="{% url 'clients' %}">Clients</a></li>
                <li class="breadcrumb-item active">Onboarding</li>
            </ol>
        </nav>
    </div><!-- End Page Title -->

    <div class="card">
        <div class="card-body">
            <h5 class="card-title" id="formTitle">Client Basic Information <small class="text-muted">(<span class="text-danger">*</span> indicates required field)</small></h5>

            <!-- Basic Client Form -->
            <form id="clientBasicForm" method="post" class="row g-3" novalidate style="display: block;">
                {% csrf_token %}

                <!-- Row 1: Client Name & Primary Contact -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ client_form.client_name.id_for_label }}" class="form-label">Client Name <span class="text-danger">*</span></label>
                            {{ client_form.client_name }}
                            <div class="invalid-feedback" id="client_name_error"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ client_form.primary_contact_name.id_for_label }}" class="form-label">Primary Contact Name <span class="text-danger">*</span></label>
                            {{ client_form.primary_contact_name }}
                            <div class="invalid-feedback" id="primary_contact_name_error"></div>
                        </div>
                    </div>
                </div>

                <!-- Row 2: PAN & Email -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ client_form.pan_no.id_for_label }}" class="form-label">PAN No. <span class="text-danger">*</span></label>
                            {{ client_form.pan_no }}
                            <div class="invalid-feedback" id="pan_no_error"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ client_form.email.id_for_label }}" class="form-label">Email <span class="text-danger">*</span></label>
                            {{ client_form.email }}
                            <div class="invalid-feedback" id="email_error"></div>
                        </div>
                    </div>
                </div>

                <!-- Row 3: Client Type & Business Structure (MOVED UP) -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ client_form.client_type.id_for_label }}" class="form-label">Client Type <span class="text-danger">*</span></label>
                            {{ client_form.client_type }}
                            <div class="invalid-feedback" id="client_type_error"></div>
                        </div>
                    </div>
                    <div class="col-md-6" id="businessStructureField" style="display: none;">
                        <div class="mb-3">
                            <label for="{{ client_form.business_structure.id_for_label }}" class="form-label">Business Structure <span class="text-danger">*</span></label>
                            {{ client_form.business_structure }}
                            <div class="invalid-feedback" id="business_structure_error"></div>
                        </div>
                    </div>
                </div>

                <!-- Row 4: Contact No, Aadhar No & DIN No in single row -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="{{ client_form.phone_number.id_for_label }}" class="form-label">Contact No. <span class="text-danger">*</span></label>
                            {{ client_form.phone_number }}
                            <div class="invalid-feedback" id="phone_number_error"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="{{ client_form.aadhar.id_for_label }}" class="form-label">Aadhar No. <span id="aadhar_required" class="text-danger" style="display: none;">*</span></label>
                            {{ client_form.aadhar }}
                            <div class="invalid-feedback" id="aadhar_error"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="{{ client_form.din_no.id_for_label }}" class="form-label">DIN No. <span id="din_required" class="text-danger" style="display: none;">*</span></label>
                            {{ client_form.din_no }}
                            <div class="invalid-feedback" id="din_no_error"></div>
                        </div>
                    </div>
                </div>

                <!-- Existing Row 5: Address -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="mb-3">
                            <label for="{{ client_form.address_line1.id_for_label }}" class="form-label">Address Line 1 (Street Name, House No., Landmark) <span class="text-danger">*</span></label>
                            {{ client_form.address_line1 }}
                            <div class="invalid-feedback" id="address_line1_error"></div>
                        </div>
                    </div>
                </div>

                <!-- Existing Row 6: City, State, Postal Code -->
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="{{ client_form.city.id_for_label }}" class="form-label">City <span class="text-danger">*</span></label>
                            {{ client_form.city }}
                            <div class="invalid-feedback" id="city_error"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="{{ client_form.state.id_for_label }}" class="form-label">State <span class="text-danger">*</span></label>
                            {{ client_form.state }}
                            <div class="invalid-feedback" id="state_error"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="{{ client_form.postal_code.id_for_label }}" class="form-label">Postal Code <span class="text-danger">*</span></label>
                            {{ client_form.postal_code }}
                            <div class="invalid-feedback" id="postal_code_error"></div>
                        </div>
                    </div>
                </div>

                <!-- Existing Row 7: Country & Date of Engagement -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ client_form.country.id_for_label }}" class="form-label">Country <span class="text-danger">*</span></label>
                            {{ client_form.country }}
                            <div class="invalid-feedback" id="country_error"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ client_form.date_of_engagement.id_for_label }}" class="form-label">Date of Engagement <span class="text-danger">*</span></label>
                            {{ client_form.date_of_engagement }}
                            <div class="invalid-feedback" id="date_of_engagement_error"></div>
                        </div>
                    </div>
                </div>

                <!-- Row 8: Assigned CA & Status -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ client_form.assigned_ca.id_for_label }}" class="form-label">Assigned CA/Article <span class="text-danger">*</span></label>
                            {{ client_form.assigned_ca }}
                            <div class="invalid-feedback" id="assigned_ca_error"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ client_form.status.id_for_label }}" class="form-label">Status <span class="text-danger">*</span></label>
                            {{ client_form.status }}
                            <div class="invalid-feedback" id="status_error"></div>
                        </div>
                    </div>
                </div>

                <!-- Row 9: Remarks -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="mb-3">
                            <label for="{{ client_form.remarks.id_for_label }}" class="form-label">Remarks</label>
                            {{ client_form.remarks }}
                            <div class="invalid-feedback" id="remarks_error"></div>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <button type="button" id="clearButton" class="btn btn-warning">Clear Form</button>
                            <div id="submitButtons">
                                <!-- Buttons will be dynamically shown based on client type -->
                            </div>
                        </div>
                    </div>
                </div>
            </form>

            <!-- Dynamic form container for business structure details -->
            <div id="businessStructureForm" style="display: none;"></div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        Client Created Successfully
                    </h5>
                </div>
                <div class="modal-body text-center">
                    <div class="mb-3">
                        <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="text-success mb-3">Client Onboarded Successfully!</h5>
                    <p class="mb-1"><strong>Client Name:</strong> <span id="successClientName"></span></p>
                    <p class="mb-3"><strong>Client ID:</strong> <span id="successClientId" class="badge bg-primary"></span></p>
                    <p class="text-muted small">Please note down the Client ID for future reference.</p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-success" id="successOkButton">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Processing...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Clear Form Confirmation Modal -->
    <div class="modal fade" id="clearFormModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Clear Form</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to clear all form data? This action cannot be undone.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" id="confirmClearButton">Clear Form</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Review Modal -->
    <div class="modal fade" id="reviewModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="reviewModalTitle">
                        <i class="bi bi-eye-fill me-2"></i>
                        Review Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        Please review all the details before saving the client.
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2 mb-3">Basic Information</h6>
                        </div>
                    </div>

                    <div class="row" id="reviewContent">
                        <!-- Review content will be dynamically populated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" id="confirmSaveButton">
                        <i class="bi bi-check-circle-fill me-1"></i>Save Client
                    </button>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    // Defining URLs as global variables
    const URLS = {
        save_client_basic: "{% url 'save_client_basic' %}",
        save_client_complete: "{% url 'save_client_complete' %}",
        save_individual_client: "{% url 'save_individual_client' %}",
        clear_client_session: "{% url 'clear_client_session' %}",
        clients: "{% url 'clients' %}"
    };
</script>
<script src="{% static 'assets/js/client_onboarding.js' %}"></script>
{% endblock body %}