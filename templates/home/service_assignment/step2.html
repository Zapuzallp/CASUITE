{% extends 'base.html' %}

{% block title %}Service Assignment - Step 2 - CA Suite 2.0{% endblock %}

{% block body %}
<main id="main" class="main">
    <div class="pagetitle">
        <h1>Service Assignment Wizard</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Home</a></li>
                <li class="breadcrumb-item">Clients</li>
                <li class="breadcrumb-item active">Service Assignment</li>
            </ol>
        </nav>
    </div>

    <section class="section">
        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-gear"></i> Assign {{ service_type.service_name }} service to {{ client.client_name }}
                        </h5>
                        
                        <!-- Progress Steps -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-center">
                                    <div class="d-flex align-items-center">
                                        <div class="text-center">
                                            <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center mb-2" style="width: 40px; height: 40px;">
                                                <i class="bi bi-check-lg"></i>
                                            </div>
                                            <small class="fw-bold text-success">Basic Details</small>
                                        </div>
                                        <div class="bg-success mx-3" style="width: 80px; height: 2px;"></div>
                                        <div class="text-center">
                                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center mb-2" style="width: 40px; height: 40px;">
                                                <i class="bi bi-2-circle-fill"></i>
                                            </div>
                                            <small class="fw-bold">Service Specific</small>
                                        </div>
                                        <div class="bg-light mx-3" style="width: 80px; height: 2px;"></div>
                                        <div class="text-center">
                                            <div class="bg-light text-muted rounded-circle d-flex align-items-center justify-content-center mb-2" style="width: 40px; height: 40px;">
                                                <i class="bi bi-3-circle"></i>
                                            </div>
                                            <small class="text-muted">Review & Submit</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Client & Service Information -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card border-primary h-100">
                                    <div class="card-body">
                                        <h6 class="card-title text-primary">
                                            <i class="bi bi-person-fill"></i> Client Information
                                        </h6>
                                        <p class="mb-1"><strong>Name:</strong> {{ client.client_name }}</p>
                                        <p class="mb-1"><strong>Email:</strong> {{ client.email }}</p>
                                        <p class="mb-1"><strong>Phone:</strong> {{ client.phone_number }}</p>
                                        <p class="mb-0"><strong>Type:</strong> {{ client.get_client_type_display }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card border-success h-100">
                                    <div class="card-body">
                                        <h6 class="card-title text-success">
                                            <i class="bi bi-gear-fill"></i> Service Information
                                        </h6>
                                        <p class="mb-1"><strong>Service:</strong> {{ service_type.service_name }}</p>
                                        <p class="mb-1"><strong>Category:</strong> {{ service_type.get_category_display }}</p>
                                        <p class="mb-1"><strong>Frequency:</strong> {{ service_type.get_frequency_display }}</p>
                                        <p class="mb-0"><strong>Default Due Days:</strong> {{ service_type.default_due_days }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Messages -->
                        {% if messages %}
                            {% for message in messages %}
                                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                    <i class="bi bi-{% if message.tags == 'error' %}exclamation-triangle{% elif message.tags == 'success' %}check-circle{% else %}info-circle{% endif %} me-1"></i>
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                        
                        <!-- Form Section -->
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="bi bi-list-check"></i> {{ service_type.service_name }} Specific Details
                                </h5>
                                <p class="text-muted">Please provide specific information required for {{ service_type.service_name }} service.</p>
                                <div class="alert alert-info alert-dismissible fade show" role="alert">
                                    <i class="bi bi-magic"></i> <strong>Smart Fill:</strong> Look for <span class="badge bg-primary">Use Client Data</span> buttons next to fields that can be auto-filled from your client profile!
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>

                                <form method="post" enctype="multipart/form-data" novalidate>
                                    {% csrf_token %}

                                    <div class="row g-3">
                                        {% for field in form %}
                                            {% if field.name == 'remarks' or 'description' in field.name|lower %}
                                                <!-- Full width for remarks/description fields -->
                                                <div class="col-12">
                                                    <label for="{{ field.id_for_label }}" class="form-label">
                                                        <i class="bi bi-chat-text"></i> {{ field.label }}
                                                        {% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                                                    </label>
                                                    {{ field }}
                                                    {% if field.errors %}
                                                        <div class="invalid-feedback d-block">
                                                            {% for error in field.errors %}{{ error }}{% endfor %}
                                                        </div>
                                                    {% endif %}
                                                    {% if field.help_text %}
                                                        <div class="form-text">{{ field.help_text }}</div>
                                                    {% endif %}
                                                </div>
                                            {% elif field.field.widget.input_type == 'checkbox' %}
                                                <!-- Full width for checkboxes -->
                                                <div class="col-12">
                                                    <div class="form-check">
                                                        {{ field }}
                                                        <label class="form-check-label" for="{{ field.id_for_label }}">
                                                            <i class="bi bi-check-square"></i> {{ field.label }}
                                                        </label>
                                                    </div>
                                                    {% if field.errors %}
                                                        <div class="invalid-feedback d-block">
                                                            {% for error in field.errors %}{{ error }}{% endfor %}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            {% elif field.field.widget.input_type == 'file' %}
                                                <!-- Full width for file fields -->
                                                <div class="col-12">
                                                    <label for="{{ field.id_for_label }}" class="form-label">
                                                        <i class="bi bi-file-earmark-arrow-up"></i> {{ field.label }}
                                                        {% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                                                    </label>
                                                    {{ field }}
                                                    {% if field.errors %}
                                                        <div class="invalid-feedback d-block">
                                                            {% for error in field.errors %}{{ error }}{% endfor %}
                                                        </div>
                                                    {% endif %}
                                                    {% if field.help_text %}
                                                        <div class="form-text">{{ field.help_text }}</div>
                                                    {% endif %}
                                                </div>
                                            {% else %}
                                                <!-- Two columns for regular fields -->
                                                <div class="col-md-6">
                                                    <label for="{{ field.id_for_label }}" class="form-label">
                                                        {% if 'pan' in field.name|lower %}
                                                            <i class="bi bi-card-text"></i>
                                                        {% elif 'aadhaar' in field.name|lower %}
                                                            <i class="bi bi-person-vcard"></i>
                                                        {% elif 'year' in field.name|lower %}
                                                            <i class="bi bi-calendar"></i>
                                                        {% elif 'income' in field.name|lower %}
                                                            <i class="bi bi-currency-rupee"></i>
                                                        {% elif 'date' in field.name|lower %}
                                                            <i class="bi bi-calendar-event"></i>
                                                        {% elif 'type' in field.name|lower %}
                                                            <i class="bi bi-tags"></i>
                                                        {% elif 'mode' in field.name|lower %}
                                                            <i class="bi bi-gear"></i>
                                                        {% elif 'number' in field.name|lower %}
                                                            <i class="bi bi-hash"></i>
                                                        {% else %}
                                                            <i class="bi bi-pencil"></i>
                                                        {% endif %}
                                                        {{ field.label }}
                                                        {% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                                                    </label>
                                                    {{ field }}
                                                    {% if field.errors %}
                                                        <div class="invalid-feedback d-block">
                                                            {% for error in field.errors %}{{ error }}{% endfor %}
                                                        </div>
                                                    {% endif %}
                                                    {% if field.help_text %}
                                                        <div class="form-text">{{ field.help_text }}</div>
                                                    {% endif %}
                                                </div>
                                            {% endif %}
                                        {% endfor %}

                                        <!-- Navigation Buttons -->
                                        <div class="col-12">
                                            <div class="d-flex justify-content-between mt-4">
                                                <a href="{% url 'service_assignment_step1' client_id=client.id service_id=service_type.id %}" class="btn btn-secondary">
                                                    <i class="bi bi-arrow-left"></i> Back: Basic Details
                                                </a>
                                                <button type="submit" class="btn btn-primary">
                                                    <i class="bi bi-arrow-right"></i> Next: Review & Submit
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-suggest functionality
    const clientId = parseInt('{{ client.id }}');
    let clientSuggestions = {};

    // Fetch client suggestions
    fetch(`/api/client/${clientId}/suggestions/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                clientSuggestions = data.suggestions;
                addSuggestionButtons();
            }
        })
        .catch(error => console.error('Error fetching suggestions:', error));

    function addSuggestionButtons() {
        // Field mapping - maps form field names to client data keys
        const fieldMappings = {
            'pan_number': 'pan_number',
            'aadhaar_number': 'aadhaar_number',
            'email': 'email',
            'phone_number': 'phone_number',
            'address': 'address',
            'city': 'city',
            'state': 'state',
            'postal_code': 'postal_code',
            'gst_username': 'email',  // Suggest email for GST username
            'contact_person': 'primary_contact_name'
        };

        // Add suggestion buttons to matching fields
        Object.keys(fieldMappings).forEach(fieldName => {
            const field = document.querySelector(`[name="${fieldName}"], [name*="${fieldName}"]`);
            if (field && clientSuggestions[fieldMappings[fieldName]]) {
                addSuggestionButton(field, clientSuggestions[fieldMappings[fieldName]]);
            }
        });
    }

    function addSuggestionButton(field, suggestionValue) {
        // Create suggestion button
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'btn btn-sm btn-outline-primary ms-2 suggestion-btn';
        button.innerHTML = '<i class="bi bi-magic"></i> Use Client Data';
        button.title = `Click to use: ${suggestionValue}`;
        button.style.fontSize = '11px';
        button.style.padding = '2px 8px';

        // Add click handler
        button.addEventListener('click', function() {
            showConfirmModal(
                'Use Client Data',
                `Do you want to use "${suggestionValue}" from client profile?`,
                () => {
                    field.value = suggestionValue;
                    field.dispatchEvent(new Event('change')); // Trigger change event

                    // Visual feedback
                    field.classList.add('border-success');
                    setTimeout(() => field.classList.remove('border-success'), 2000);

                    showSuccessModal('Success!', `Field filled with client data: ${suggestionValue}`);
                }
            );
        });

        // Insert button after the field
        const fieldContainer = field.closest('.col-md-6, .col-12');
        if (fieldContainer) {
            const label = fieldContainer.querySelector('label');
            if (label) {
                label.appendChild(button);
            }
        }
    }

    // Modal functions
    function showConfirmModal(title, message, onConfirm) {
        document.getElementById('confirmModalTitle').textContent = title;
        document.getElementById('confirmModalMessage').textContent = message;

        const confirmBtn = document.getElementById('confirmModalBtn');
        confirmBtn.onclick = function() {
            onConfirm();
            bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
        };

        new bootstrap.Modal(document.getElementById('confirmModal')).show();
    }

    function showSuccessModal(title, message) {
        document.getElementById('successModalTitle').textContent = title;
        document.getElementById('successModalMessage').textContent = message;
        new bootstrap.Modal(document.getElementById('successModal')).show();
    }

    // Add Bootstrap validation classes to all form fields with errors
    document.querySelectorAll('.invalid-feedback').forEach(function(errorDiv) {
        const fieldContainer = errorDiv.closest('.col-md-6, .col-12, .form-group');
        if (fieldContainer) {
            const field = fieldContainer.querySelector('input, select, textarea');
            if (field) {
                field.classList.add('is-invalid');

                // Add red border for better visibility
                field.style.borderColor = '#dc3545';
                field.style.boxShadow = '0 0 0 0.2rem rgba(220, 53, 69, 0.25)';

                // Focus on first invalid field
                if (!document.querySelector('.is-invalid:focus')) {
                    field.focus();
                }
            }
        }
    });

    // Add real-time validation feedback
    document.querySelectorAll('input[required], select[required], textarea[required]').forEach(function(field) {
        field.addEventListener('blur', function() {
            if (this.value.trim() === '') {
                this.classList.add('is-invalid');

                // Create or update error message
                let errorDiv = this.parentNode.querySelector('.invalid-feedback');
                if (!errorDiv) {
                    errorDiv = document.createElement('div');
                    errorDiv.className = 'invalid-feedback';
                    this.parentNode.appendChild(errorDiv);
                }
                errorDiv.textContent = 'This field is required.';
                errorDiv.style.display = 'block';
            } else {
                this.classList.remove('is-invalid');
                const errorDiv = this.parentNode.querySelector('.invalid-feedback');
                if (errorDiv && errorDiv.textContent === 'This field is required.') {
                    errorDiv.style.display = 'none';
                }
            }
        });

        field.addEventListener('input', function() {
            if (this.classList.contains('is-invalid') && this.value.trim() !== '') {
                this.classList.remove('is-invalid');
                const errorDiv = this.parentNode.querySelector('.invalid-feedback');
                if (errorDiv && errorDiv.textContent === 'This field is required.') {
                    errorDiv.style.display = 'none';
                }
            }
        });
    });
});
</script>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalTitle" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalTitle">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="confirmModalMessage">Are you sure?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmModalBtn">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalTitle" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="successModalTitle">Success</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="successModalMessage">Operation completed successfully!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
