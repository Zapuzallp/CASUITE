{% extends 'base.html' %}
{% load static %}

{% block body %}
<main id="main" class="main">
    {% if messages %}
        {% for message in messages %}
            {% if message.tags == 'error' or message.tags == 'warning' %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle-fill"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}
        {% endfor %}
    {% endif %}

    <div class="pagetitle">
        <h1>Onboard New Client</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Home</a></li>
                <li class="breadcrumb-item"><a href="{% url 'clients' %}">Clients</a></li>
                <li class="breadcrumb-item active">Onboarding</li>
            </ol>
        </nav>
    </div><!-- End Page Title -->

    <div class="card">
        <div class="card-body">
            <h5 class="card-title" id="formTitle">Client Basic Information</h5>

            <!-- Basic Client Form -->
            <form id="clientBasicForm" method="post" class="row g-3" novalidate style="display: block;">
                {% csrf_token %}

                <!-- Row 1: Client Name & Primary Contact -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ client_form.client_name.id_for_label }}" class="form-label">Client Name *</label>
                            {{ client_form.client_name }}
                            <div class="invalid-feedback" id="client_name_error"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ client_form.primary_contact_name.id_for_label }}" class="form-label">Primary Contact Name *</label>
                            {{ client_form.primary_contact_name }}
                            <div class="invalid-feedback" id="primary_contact_name_error"></div>
                        </div>
                    </div>
                </div>

                <!-- Row 2: PAN & Email -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ client_form.pan_no.id_for_label }}" class="form-label">PAN No. *</label>
                            {{ client_form.pan_no }}
                            <div class="invalid-feedback" id="pan_no_error"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ client_form.email.id_for_label }}" class="form-label">Email *</label>
                            {{ client_form.email }}
                            <div class="invalid-feedback" id="email_error"></div>
                        </div>
                    </div>
                </div>

                <!-- Row 3: Phone & Aadhar -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ client_form.phone_number.id_for_label }}" class="form-label">Contact No. *</label>
                            {{ client_form.phone_number }}
                            <div class="invalid-feedback" id="phone_number_error"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ client_form.aadhar.id_for_label }}" class="form-label">Aadhar No. *</label>
                            {{ client_form.aadhar }}
                            <div class="invalid-feedback" id="aadhar_error"></div>
                        </div>
                    </div>
                </div>

                <!-- Row 4: Address -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="mb-3">
                            <label for="{{ client_form.address_line1.id_for_label }}" class="form-label">Address *</label>
                            {{ client_form.address_line1 }}
                            <div class="invalid-feedback" id="address_line1_error"></div>
                        </div>
                    </div>
                </div>

                <!-- Row 5: City, State, Postal Code -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="{{ client_form.city.id_for_label }}" class="form-label">City *</label>
                            {{ client_form.city }}
                            <div class="invalid-feedback" id="city_error"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="{{ client_form.state.id_for_label }}" class="form-label">State *</label>
                            {{ client_form.state }}
                            <div class="invalid-feedback" id="state_error"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="{{ client_form.postal_code.id_for_label }}" class="form-label">Postal Code *</label>
                            {{ client_form.postal_code }}
                            <div class="invalid-feedback" id="postal_code_error"></div>
                        </div>
                    </div>
                </div>

                <!-- Row 6: Country & Date of Engagement -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ client_form.country.id_for_label }}" class="form-label">Country *</label>
                            {{ client_form.country }}
                            <div class="invalid-feedback" id="country_error"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ client_form.date_of_engagement.id_for_label }}" class="form-label">Date of Engagement *</label>
                            {{ client_form.date_of_engagement }}
                            <div class="invalid-feedback" id="date_of_engagement_error"></div>
                        </div>
                    </div>
                </div>

                <!-- Row 7: Client Type & Business Structure -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ client_form.client_type.id_for_label }}" class="form-label">Client Type *</label>
                            {{ client_form.client_type }}
                            <div class="invalid-feedback" id="client_type_error"></div>
                        </div>
                    </div>
                    <div class="col-md-6" id="businessStructureField" style="display: none;">
                        <div class="mb-3">
                            <label for="{{ client_form.business_structure.id_for_label }}" class="form-label">Business Structure *</label>
                            {{ client_form.business_structure }}
                            <div class="invalid-feedback" id="business_structure_error"></div>
                        </div>
                    </div>
                </div>

                <!-- Row 8: Assigned CA & Status -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ client_form.assigned_ca.id_for_label }}" class="form-label">Assigned CA *</label>
                            {{ client_form.assigned_ca }}
                            <div class="invalid-feedback" id="assigned_ca_error"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ client_form.status.id_for_label }}" class="form-label">Status *</label>
                            {{ client_form.status }}
                            <div class="invalid-feedback" id="status_error"></div>
                        </div>
                    </div>
                </div>

                <!-- Row 9: DIN No & Empty space for alignment -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ client_form.din_no.id_for_label }}" class="form-label">DIN No.</label>
                            {{ client_form.din_no }}
                            <div class="invalid-feedback" id="din_no_error"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <!-- Empty column for alignment -->
                    </div>
                </div>

                <!-- Row 10: Remarks -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="mb-3">
                            <label for="{{ client_form.remarks.id_for_label }}" class="form-label">Remarks</label>
                            {{ client_form.remarks }}
                            <div class="invalid-feedback" id="remarks_error"></div>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <button type="button" id="clearButton" class="btn btn-warning">Clear Form</button>
                            <div id="submitButtons">
                                <!-- Buttons will be dynamically shown based on client type -->
                            </div>
                        </div>
                    </div>
                </div>
            </form>

            <!-- Dynamic form container for business structure details -->
            <div id="businessStructureForm" style="display: none;"></div>
        </div>
    </div>
</main>

<!-- Loading Spinner -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Processing...</p>
            </div>
        </div>
    </div>
</div>

<!-- Clear Form Confirmation Modal -->
<div class="modal fade" id="clearFormModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Clear Form</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to clear all form data? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirmClearButton">Clear Form</button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Your existing CSS styles */
    .is-invalid {
        border-color: #dc3545 !important;
    }

    .invalid-feedback {
        display: block;
        width: 100%;
        margin-top: 0.25rem;
        font-size: 0.875em;
        color: #dc3545;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const clientTypeField = document.getElementById('{{ client_form.client_type.id_for_label }}');
    const businessStructureField = document.getElementById('businessStructureField');
    const submitButtonsContainer = document.getElementById('submitButtons');
    const clientBasicForm = document.getElementById('clientBasicForm');
    const businessStructureForm = document.getElementById('businessStructureForm');
    const formTitle = document.getElementById('formTitle');
    const clearButton = document.getElementById('clearButton');
    const confirmClearButton = document.getElementById('confirmClearButton');
    const loadingOverlay = document.getElementById('customLoadingOverlay'); // Changed to overlay
    const clearFormModal = new bootstrap.Modal(document.getElementById('clearFormModal'));
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;

    let currentState = 'basic';

    // Simple and reliable loading overlay functions
    function showLoading() {
        console.log('Showing loading overlay');
        if (loadingOverlay) {
            loadingOverlay.style.display = 'block';
            // Prevent body scrolling
            document.body.style.overflow = 'hidden';
        }
    }

    function hideLoading() {
        console.log('Hiding loading overlay');
        if (loadingOverlay) {
            loadingOverlay.style.display = 'none';
            // Restore body scrolling
            document.body.style.overflow = '';
        }

        // Additional safety - force hide after short delay
        setTimeout(() => {
            if (loadingOverlay && loadingOverlay.style.display !== 'none') {
                loadingOverlay.style.display = 'none';
                document.body.style.overflow = '';
            }
        }, 100);
    }

    // Initialize form
    initializeForm();

    function initializeForm() {
        console.log('Initializing form...');
        currentState = 'basic';
        clientBasicForm.style.display = 'block';
        businessStructureForm.style.display = 'none';
        businessStructureForm.innerHTML = '';
        formTitle.textContent = 'Client Basic Information';
        toggleBusinessStructure();
        updateSubmitButtons();
        setupRealTimeValidation();
    }

    function setupRealTimeValidation() {
        const mandatoryFields = [
            'client_name', 'primary_contact_name', 'pan_no', 'email',
            'phone_number', 'address_line1', 'aadhar', 'city', 'state',
            'postal_code', 'country', 'date_of_engagement', 'assigned_ca',
            'client_type', 'status'
        ];

        mandatoryFields.forEach(fieldName => {
            const field = document.getElementById(`id_${fieldName}`);
            if (field) {
                field.removeEventListener('blur', validateField);
                field.removeEventListener('input', clearFieldError);
                field.addEventListener('blur', validateField);
                field.addEventListener('input', clearFieldError);
            }
        });

        const phoneField = document.getElementById('id_phone_number');
        if (phoneField) {
            phoneField.addEventListener('input', formatPhoneNumber);
        }

        const postalCodeField = document.getElementById('id_postal_code');
        if (postalCodeField) {
            postalCodeField.addEventListener('input', formatPostalCode);
            postalCodeField.addEventListener('blur', validatePostalCode);
        }

        const aadharField = document.getElementById('id_aadhar');
        if (aadharField) {
            aadharField.addEventListener('input', formatAadhar);
        }

        const panField = document.getElementById('id_pan_no');
        if (panField) {
            panField.addEventListener('input', function(e) {
                this.value = this.value.toUpperCase();
                clearFieldError.call(this);
            });
        }
    }

    function formatPostalCode(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 6) value = value.substring(0, 6);
        e.target.value = value;
        clearFieldError.call(e.target);
    }

    function validatePostalCode(e) {
        const field = e.target;
        const value = field.value.trim();
        clearFieldError.call(field);

        if (!value) {
            showFieldError(field, 'Postal code is required.');
            return false;
        }

        if (value.length !== 6) {
            showFieldError(field, 'Postal code must be exactly 6 digits.');
            return false;
        }

        if (!/^\d{6}$/.test(value)) {
            showFieldError(field, 'Postal code must contain only numbers.');
            return false;
        }

        return true;
    }

    function formatPhoneNumber(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 10) value = value.substring(0, 10);
        e.target.value = value;
        clearFieldError.call(e.target);
    }

    function formatAadhar(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 12) value = value.substring(0, 12);
        e.target.value = value;
        clearFieldError.call(e.target);
    }

    function validateField(e) {
        const field = e.target;
        const fieldName = field.name;
        const value = field.value.trim();
        clearFieldError.call(field);

        const mandatoryFields = [
            'client_name', 'primary_contact_name', 'pan_no', 'email',
            'phone_number', 'address_line1', 'aadhar', 'city', 'state',
            'postal_code', 'country', 'date_of_engagement', 'assigned_ca',
            'client_type', 'status'
        ];

        if (mandatoryFields.includes(fieldName) && !value) {
            showFieldError(field, 'This field is required.');
            return false;
        }

        switch(fieldName) {
            case 'phone_number':
                const phoneDigits = value.replace(/\D/g, '');
                if (phoneDigits.length !== 10) {
                    showFieldError(field, 'Phone number must be exactly 10 digits.');
                    return false;
                }
                break;

            case 'pan_no':
                if (value.length !== 10) {
                    showFieldError(field, 'PAN number must be exactly 10 characters.');
                    return false;
                }
                break;

            case 'aadhar':
                const aadharDigits = value.replace(/\D/g, '');
                if (aadharDigits.length !== 12) {
                    showFieldError(field, 'Aadhar number must be exactly 12 digits.');
                    return false;
                }
                break;

            case 'email':
                if (value && !isValidEmail(value)) {
                    showFieldError(field, 'Please enter a valid email address.');
                    return false;
                }
                break;

            case 'postal_code':
                if (value.length !== 6) {
                    showFieldError(field, 'Postal code must be exactly 6 digits.');
                    return false;
                }
                if (!/^\d{6}$/.test(value)) {
                    showFieldError(field, 'Postal code must contain only numbers.');
                    return false;
                }
                break;
        }

        return true;
    }

    function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    function showFieldError(field, message) {
        field.classList.add('is-invalid');
        const errorElement = document.getElementById(`${field.name}_error`);
        if (errorElement) {
            errorElement.textContent = message;
        }
    }

    function clearFieldError() {
        this.classList.remove('is-invalid');
        const errorElement = document.getElementById(`${this.name}_error`);
        if (errorElement) {
            errorElement.textContent = '';
        }
    }

    function validateForm() {
        let isValid = true;
        const mandatoryFields = [
            'client_name', 'primary_contact_name', 'pan_no', 'email',
            'phone_number', 'address_line1', 'aadhar', 'city', 'state',
            'postal_code', 'country', 'date_of_engagement', 'assigned_ca',
            'client_type', 'status'
        ];

        mandatoryFields.forEach(fieldName => {
            const field = document.getElementById(`id_${fieldName}`);
            if (field) {
                const event = new Event('blur', { bubbles: true });
                field.dispatchEvent(event);
                if (field.classList.contains('is-invalid')) {
                    isValid = false;
                }
            }
        });

        return isValid;
    }

    function toggleBusinessStructure() {
        if (clientTypeField.value === 'Entity') {
            businessStructureField.style.display = 'block';
        } else {
            businessStructureField.style.display = 'none';
        }
        updateSubmitButtons();
    }

    function updateSubmitButtons() {
        submitButtonsContainer.innerHTML = '';

        if (currentState === 'basic') {
            if (clientTypeField.value === 'Individual') {
                const submitButton = document.createElement('button');
                submitButton.type = 'button';
                submitButton.className = 'btn btn-success';
                submitButton.textContent = 'Submit';
                submitButton.onclick = submitIndividualForm;
                submitButtonsContainer.appendChild(submitButton);
            } else if (clientTypeField.value === 'Entity') {
                const nextButton = document.createElement('button');
                nextButton.type = 'button';
                nextButton.className = 'btn btn-primary';
                nextButton.textContent = 'Next';
                nextButton.onclick = handleNextButtonClick;
                submitButtonsContainer.appendChild(nextButton);
            }
        }
    }

    function submitIndividualForm() {
        if (!validateForm()) {
            showTemporaryAlert('Please fix the validation errors before submitting.', 'error');
            return;
        }

        showLoading();
        const formData = new FormData(clientBasicForm);

        fetch('{% url "save_client_basic" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                window.location.href = '{% url "clients" %}';
            } else {
                handleFormErrors(data);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            hideLoading();
            alert('Network error occurred. Please try again.');
        });
    }

    // Clear form functionality
    clearButton.addEventListener('click', function() {
        clearFormModal.show();
    });

    confirmClearButton.addEventListener('click', function() {
        clearFormModal.hide();
        resetFormCompletely();
    });

    function resetFormCompletely() {
        fetch('{% url "clear_client_session" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            }
        }).then(() => {
            clientBasicForm.reset();
            const selects = clientBasicForm.querySelectorAll('select');
            selects.forEach(select => {
                select.selectedIndex = 0;
            });

            const errorElements = clientBasicForm.querySelectorAll('.invalid-feedback');
            errorElements.forEach(element => {
                element.textContent = '';
            });
            const invalidFields = clientBasicForm.querySelectorAll('.is-invalid');
            invalidFields.forEach(field => {
                field.classList.remove('is-invalid');
            });

            initializeForm();
            showTemporaryAlert('Form cleared successfully!', 'success');
        }).catch(error => {
            console.error('Error clearing session:', error);
            clientBasicForm.reset();
            initializeForm();
            showTemporaryAlert('Form cleared successfully!', 'success');
        });
    }

    function showTemporaryAlert(message, type) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const alertHtml = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle-fill"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        const main = document.querySelector('main');
        const existingAlerts = main.querySelectorAll('.alert');
        existingAlerts.forEach(alert => alert.remove());
        main.insertAdjacentHTML('afterbegin', alertHtml);

        setTimeout(() => {
            const alert = main.querySelector('.alert');
            if (alert) {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }
        }, 5000);
    }

    // FIXED: Using simple overlay instead of Bootstrap modal
    function handleNextButtonClick() {
        if (!validateForm()) {
            showTemporaryAlert('Please fix the validation errors before proceeding.', 'error');
            return;
        }

        console.log('Next button clicked');
        showLoading();
        const formData = new FormData(clientBasicForm);

        fetch('{% url "save_client_basic" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Processing response data:', data);

            // HIDE LOADING FIRST - this is crucial
            hideLoading();

            if (data.success) {
                if (data.form_html) {
                    console.log('Showing business structure form');
                    showBusinessStructureForm(data);
                } else if (data.redirect_url) {
                    console.log('Redirecting to:', data.redirect_url);
                    window.location.href = data.redirect_url;
                }
            } else {
                console.log('Form errors:', data.errors);
                handleFormErrors(data);
            }
        })
        .catch(error => {
            console.error('Error in handleNextButtonClick:', error);
            hideLoading();
            alert('Network error occurred. Please try again.');
        });
    }

    function showBusinessStructureForm(data) {
        console.log('showBusinessStructureForm called');
        currentState = 'business';

        // Hide basic form and show business structure form
        clientBasicForm.style.display = 'none';
        businessStructureForm.style.display = 'block';
        businessStructureForm.innerHTML = data.form_html;
        formTitle.textContent = `${data.business_structure} Details`;

        // Add event listeners to the new form
        const backButton = businessStructureForm.querySelector('#backButton');
        if (backButton) {
            backButton.addEventListener('click', goBackToBasicForm);
        }

        const businessForm = businessStructureForm.querySelector('#businessStructureDetailsForm');
        if (businessForm) {
            businessForm.addEventListener('submit', function(e) {
                e.preventDefault();
                submitBusinessStructureForm(this);
            });
        }

        window.scrollTo(0, 0);
    }

    function submitBusinessStructureForm(form) {
        console.log('Submitting business structure form');
        showLoading();
        const formData = new FormData(form);

        fetch('{% url "save_client_complete" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            hideLoading();
            if (data.success) {
                window.location.href = '{% url "clients" %}';
            } else {
                handleFormErrors(data);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            hideLoading();
            alert('Network error occurred. Please try again.');
        });
    }

    function goBackToBasicForm() {
        console.log('Going back to basic form');
        currentState = 'basic';

        businessStructureForm.style.display = 'none';
        businessStructureForm.innerHTML = '';
        clientBasicForm.style.display = 'block';
        formTitle.textContent = 'Client Basic Information';
        toggleBusinessStructure();
        window.scrollTo(0, 0);

        fetch('{% url "clear_client_session" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
    }

    function handleFormErrors(data) {
        if (data.errors) {
            for (let field in data.errors) {
                const fieldElement = document.getElementById(`id_${field}`);
                if (fieldElement) {
                    showFieldError(fieldElement, data.errors[field].join(', '));
                }
            }
            showTemporaryAlert('Please fix the form errors before submitting.', 'error');
        } else if (data.error) {
            showTemporaryAlert('Error: ' + data.error, 'error');
        } else {
            showTemporaryAlert('An unknown error occurred.', 'error');
        }
    }

    // Event listeners
    clientTypeField.addEventListener('change', toggleBusinessStructure);

    // Handle page refresh
    window.addEventListener('beforeunload', function() {
        hideLoading();
        fetch('{% url "clear_client_session" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            keepalive: true
        });
    });

    // Global error handlers
    window.addEventListener('error', function(event) {
        console.error('Global error:', event.error);
        hideLoading();
    });

    window.addEventListener('unhandledrejection', function(event) {
        console.error('Unhandled promise rejection:', event.reason);
        hideLoading();
    });
});
</script>
{% endblock body %}