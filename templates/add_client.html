{% extends 'base.html' %}
{% load static %}

{% block body %}
<main id="main" class="main">
    {% if messages %}
        {% for message in messages %}
            {% if message.tags == 'error' or message.tags == 'warning' %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle-fill"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}
        {% endfor %}
    {% endif %}

    <div class="pagetitle">
        <h1>Onboard New Client</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Home</a></li>
                <li class="breadcrumb-item"><a href="{% url 'clients' %}">Clients</a></li>
                <li class="breadcrumb-item active">Onboarding</li>
            </ol>
        </nav>
    </div><!-- End Page Title -->

    <div class="card">
        <div class="card-body">
            <h5 class="card-title" id="formTitle">Client Basic Information <small class="text-muted">(<span class="text-danger">*</span> indicates required field)</small></h5>

            <!-- Basic Client Form -->
            <form id="clientBasicForm" method="post" class="row g-3" novalidate style="display: block;">
                {% csrf_token %}

                <!-- Row 1: Client Name & Primary Contact -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ client_form.client_name.id_for_label }}" class="form-label">Client Name <span class="text-danger">*</span></label>
                            {{ client_form.client_name }}
                            <div class="invalid-feedback" id="client_name_error"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ client_form.primary_contact_name.id_for_label }}" class="form-label">Primary Contact Name <span class="text-danger">*</span></label>
                            {{ client_form.primary_contact_name }}
                            <div class="invalid-feedback" id="primary_contact_name_error"></div>
                        </div>
                    </div>
                </div>

                <!-- Row 2: PAN & Email -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ client_form.pan_no.id_for_label }}" class="form-label">PAN No. <span class="text-danger">*</span></label>
                            {{ client_form.pan_no }}
                            <div class="invalid-feedback" id="pan_no_error"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ client_form.email.id_for_label }}" class="form-label">Email <span class="text-danger">*</span></label>
                            {{ client_form.email }}
                            <div class="invalid-feedback" id="email_error"></div>
                        </div>
                    </div>
                </div>

                <!-- Row 3: Phone & Aadhar -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ client_form.phone_number.id_for_label }}" class="form-label">Contact No. <span class="text-danger">*</span></label>
                            {{ client_form.phone_number }}
                            <div class="invalid-feedback" id="phone_number_error"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ client_form.aadhar.id_for_label }}" class="form-label">Aadhar No. <span class="text-danger">*</span></label>
                            {{ client_form.aadhar }}
                            <div class="invalid-feedback" id="aadhar_error"></div>
                        </div>
                    </div>
                </div>

                <!-- Row 4: Address -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="mb-3">
                            <label for="{{ client_form.address_line1.id_for_label }}" class="form-label">Address <span class="text-danger">*</span></label>
                            {{ client_form.address_line1 }}
                            <div class="invalid-feedback" id="address_line1_error"></div>
                        </div>
                    </div>
                </div>

                <!-- Row 5: City, State, Postal Code -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="{{ client_form.city.id_for_label }}" class="form-label">City <span class="text-danger">*</span></label>
                            {{ client_form.city }}
                            <div class="invalid-feedback" id="city_error"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="{{ client_form.state.id_for_label }}" class="form-label">State <span class="text-danger">*</span></label>
                            {{ client_form.state }}
                            <div class="invalid-feedback" id="state_error"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="{{ client_form.postal_code.id_for_label }}" class="form-label">Postal Code <span class="text-danger">*</span></label>
                            {{ client_form.postal_code }}
                            <div class="invalid-feedback" id="postal_code_error"></div>
                        </div>
                    </div>
                </div>

                <!-- Row 6: Country & Date of Engagement -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ client_form.country.id_for_label }}" class="form-label">Country <span class="text-danger">*</span></label>
                            {{ client_form.country }}
                            <div class="invalid-feedback" id="country_error"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ client_form.date_of_engagement.id_for_label }}" class="form-label">Date of Engagement <span class="text-danger">*</span></label>
                            {{ client_form.date_of_engagement }}
                            <div class="invalid-feedback" id="date_of_engagement_error"></div>
                        </div>
                    </div>
                </div>

                <!-- Row 7: Client Type & Business Structure -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ client_form.client_type.id_for_label }}" class="form-label">Client Type <span class="text-danger">*</span></label>
                            {{ client_form.client_type }}
                            <div class="invalid-feedback" id="client_type_error"></div>
                        </div>
                    </div>
                    <div class="col-md-6" id="businessStructureField" style="display: none;">
                        <div class="mb-3">
                            <label for="{{ client_form.business_structure.id_for_label }}" class="form-label">Business Structure <span class="text-danger">*</span></label>
                            {{ client_form.business_structure }}
                            <div class="invalid-feedback" id="business_structure_error"></div>
                        </div>
                    </div>
                </div>

                <!-- Row 8: Assigned CA & Status -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ client_form.assigned_ca.id_for_label }}" class="form-label">Assigned CA <span class="text-danger">*</span></label>
                            {{ client_form.assigned_ca }}
                            <div class="invalid-feedback" id="assigned_ca_error"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ client_form.status.id_for_label }}" class="form-label">Status <span class="text-danger">*</span></label>
                            {{ client_form.status }}
                            <div class="invalid-feedback" id="status_error"></div>
                        </div>
                    </div>
                </div>

                <!-- Row 9: DIN No & Empty space for alignment -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ client_form.din_no.id_for_label }}" class="form-label">DIN No.</label>
                            {{ client_form.din_no }}
                            <div class="invalid-feedback" id="din_no_error"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <!-- Empty column for alignment -->
                    </div>
                </div>

                <!-- Row 10: Remarks -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="mb-3">
                            <label for="{{ client_form.remarks.id_for_label }}" class="form-label">Remarks</label>
                            {{ client_form.remarks }}
                            <div class="invalid-feedback" id="remarks_error"></div>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <button type="button" id="clearButton" class="btn btn-warning">Clear Form</button>
                            <div id="submitButtons">
                                <!-- Buttons will be dynamically shown based on client type -->
                            </div>
                        </div>
                    </div>
                </div>
            </form>

            <!-- Dynamic form container for business structure details -->
            <div id="businessStructureForm" style="display: none;"></div>
        </div>
    </div>
    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        Client Created Successfully
                    </h5>
                </div>
                <div class="modal-body text-center">
                    <div class="mb-3">
                        <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="text-success mb-3">Client Onboarded Successfully!</h5>
                    <p class="mb-1"><strong>Client Name:</strong> <span id="successClientName"></span></p>
                    <p class="mb-3"><strong>Client ID:</strong> <span id="successClientId" class="badge bg-primary"></span></p>
                    <p class="text-muted small">Please note down the Client ID for future reference.</p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-success" id="successOkButton">OK</button>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Loading Spinner -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Processing...</p>
            </div>
        </div>
    </div>
</div>

<!-- Clear Form Confirmation Modal -->
<div class="modal fade" id="clearFormModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Clear Form</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to clear all form data? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirmClearButton">Clear Form</button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Your existing CSS styles */
    .is-invalid {
        border-color: #dc3545 !important;
    }

    .invalid-feedback {
        display: block;
        width: 100%;
        margin-top: 0.25rem;
        font-size: 0.875em;
        color: #dc3545;
    }
    /* Select2 custom styles */
    .select2-container--bootstrap-5 .select2-selection--multiple {
        min-height: 45px;
        padding: 5px;
    }

    .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__rendered {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
    }

    .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice {
        background-color: #0d6efd;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 2px 8px;
        font-size: 0.875rem;
    }

    .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice__remove {
        color: white;
        margin-right: 4px;
    }

    .select2-container--bootstrap-5 .select2-dropdown {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
    }

    /* Fix for business structure field visibility */
    #businessStructureField[style*="display: block"] {
        display: block !important;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elements & state
    const clientBasicForm = document.getElementById('clientBasicForm');
    const businessStructureForm = document.getElementById('businessStructureForm');
    const businessStructureField = document.getElementById('businessStructureField');
    const submitButtonsContainer = document.getElementById('submitButtons');
    const formTitle = document.getElementById('formTitle');
    const clearButton = document.getElementById('clearButton');
    const confirmClearButton = document.getElementById('confirmClearButton');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    const clientTypeSelectId = 'id_client_type';
    const clientTypeField = document.getElementById(clientTypeSelectId);

    let currentState = 'basic';
    let requestInFlight = false;
    let loadingModalInstance = null;

    // Modal helpers (Bootstrap 5 safe)
    function createLoadingInstance() {
        const el = document.getElementById('loadingModal');
        if (!el) return null;
        // If an instance already exists (from previous show), reuse it
        const existing = bootstrap.Modal.getInstance(el);
        if (existing) return existing;
        return new bootstrap.Modal(el, { backdrop: 'static', keyboard: false });
    }

    function showLoading() {
        try {
            // Ensure we have a valid instance and call .show()
            if (!loadingModalInstance) {
                loadingModalInstance = createLoadingInstance();
            }
            if (loadingModalInstance) {
                loadingModalInstance.show();
            } else {
                // Fallback: if modal element missing, add a simple overlay class (very defensive)
                console.warn('Loading modal element not found.');
            }
        } catch (err) {
            console.error('showLoading error', err);
        }
    }

    function hideLoading() {
        try {
            console.log('[loader] hideLoading called. instance:', !!loadingModalInstance);
            // Prefer the Bootstrap API
            const el = document.getElementById('loadingModal');
            const inst = loadingModalInstance || (el ? bootstrap.Modal.getInstance(el) : null);

            if (inst && typeof inst.hide === 'function') {
                inst.hide();
                console.log('[loader] called instance.hide()');
            } else {
                console.log('[loader] no bootstrap instance found — will perform manual cleanup');
            }

            // clear local reference so next show recreates it
            loadingModalInstance = null;

            // Slight delay then ensure backdrop/body cleaned (idempotent)
            setTimeout(() => {
                const backdrops = document.querySelectorAll('.modal-backdrop');
                if (backdrops.length > 0) {
                    console.warn('[loader] removing leftover backdrops:', backdrops.length);
                    backdrops.forEach(b => b.remove());
                }
                if (document.body.classList.contains('modal-open')) {
                    console.warn('[loader] removing modal-open class from body');
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                }
            }, 120);
        } catch (err) {
            console.error('[loader] hideLoading error', err);
            // last-resort cleanup
            setTimeout(() => {
                document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
            }, 150);
        }
    }

    function cleanupModalState() {
        // Remove loading modal backdrop specifically
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => {
            if (backdrop.parentNode) {
                backdrop.remove();
            }
        });

        // Reset body styles only if no other modals are open
        const openModals = document.querySelectorAll('.modal.show');
        if (openModals.length === 0) {
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        }
    }

    // --------- Select2 helpers ----------
    function initializeSelect2(context = document) {
        $(context).find('.select2-multiple').select2({
            theme: 'bootstrap-5',
            width: '100%',
            placeholder: function() { return $(this).data('placeholder'); },
            allowClear: true,
            closeOnSelect: false
        });

        $(context).find('.form-select:not(.select2-multiple)').select2({
            theme: 'bootstrap-5',
            width: '100%',
            minimumResultsForSearch: 10
        });

        // Special handling for business structure field
        const businessStructureField = context.querySelector('#id_business_structure');
        if (businessStructureField) {
            console.log('Setting up Select2 change handler for business structure');
            $(businessStructureField).off('change.select2-business');
            $(businessStructureField).on('change.select2-business', function(e) {
                console.log('Business structure Select2 changed to:', this.value);
                // Clear error immediately when a value is selected
                clearFieldError.call(this);
            });
        }
    }

    function destroySelect2(context = document) {
        try {
            $(context).find('.select2-multiple').select2('destroy');
        } catch (e) {}
        try {
            $(context).find('.form-select').select2('destroy');
        } catch (e) {}
    }

    // --------- Validation helpers ----------
    function showFieldError(field, message) {
        field.classList.add('is-invalid');
        const errorElement = document.getElementById(`${field.name}_error`);
        if (errorElement) {
            errorElement.textContent = message;
        } else {
            console.warn('Error element not found for:', field.name);
            // Create error element if it doesn't exist
            const errorDiv = document.createElement('div');
            errorDiv.className = 'invalid-feedback';
            errorDiv.id = `${field.name}_error`;
            errorDiv.textContent = message;
            field.parentNode.appendChild(errorDiv);
        }
    }

    function clearFieldError() {
        this.classList.remove('is-invalid');
        const errorElement = document.getElementById(`${this.name}_error`);
        if (errorElement) {
            errorElement.textContent = '';
        }
    }

    function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    function validateField(e) {
        const field = e.target;
        const fieldName = field.name;
        const value = field.value.trim();
        field.classList.remove('is-invalid');

        const mandatoryFields = [
            'client_name', 'primary_contact_name', 'pan_no', 'email',
            'phone_number', 'address_line1', 'aadhar', 'city', 'state',
            'postal_code', 'country', 'date_of_engagement', 'assigned_ca',
            'client_type', 'status'
        ];

        if (mandatoryFields.includes(fieldName) && !value) {
            showFieldError(field, 'This field is required.');
            return false;
        }

        switch(fieldName) {
            case 'phone_number':
                const phoneDigits = value.replace(/\D/g, '');
                if (phoneDigits.length !== 10) {
                    showFieldError(field, 'Phone number must be exactly 10 digits.');
                    return false;
                }
                break;
            case 'pan_no':
                if (value.length !== 10) {
                    showFieldError(field, 'PAN number must be exactly 10 characters.');
                    return false;
                }
                break;
            case 'aadhar':
                const aadharDigits = value.replace(/\D/g, '');
                if (aadharDigits.length !== 12) {
                    showFieldError(field, 'Aadhar number must be exactly 12 digits.');
                    return false;
                }
                break;
            case 'email':
                if (value && !isValidEmail(value)) {
                    showFieldError(field, 'Please enter a valid email address.');
                    return false;
                }
                break;
            case 'postal_code':
                if (!/^\d{6}$/.test(value)) {
                    showFieldError(field, 'Postal code must be exactly 6 digits.');
                    return false;
                }
                break;
        }
        return true;
    }

    function setupRealTimeValidation() {
        const mandatoryFields = [
            'client_name', 'primary_contact_name', 'pan_no', 'email',
            'phone_number', 'address_line1', 'aadhar', 'city', 'state',
            'postal_code', 'country', 'date_of_engagement', 'assigned_ca',
            'client_type', 'status'
        ];

        mandatoryFields.forEach(fieldName => {
            const field = document.getElementById(`id_${fieldName}`);
            if (field) {
                field.removeEventListener('blur', validateField);
                field.removeEventListener('input', clearFieldError);
                field.addEventListener('blur', validateField);
                field.addEventListener('input', clearFieldError);
            }
        });

        // Simple business structure validation
        const businessStructureField = document.getElementById('id_business_structure');
        if (businessStructureField) {
            businessStructureField.removeEventListener('change', handleBusinessStructureChange);
            businessStructureField.addEventListener('change', handleBusinessStructureChange);
        }

        const phoneField = document.getElementById('id_phone_number');
        if (phoneField) {
            phoneField.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 10) value = value.substring(0, 10);
                e.target.value = value;
                clearFieldError.call(e.target);
            });
        }

        const postalField = document.getElementById('id_postal_code');
        if (postalField) {
            postalField.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 6) value = value.substring(0,6);
                e.target.value = value;
                clearFieldError.call(e.target);
            });
            postalField.addEventListener('blur', validateField);
        }

        const aadharField = document.getElementById('id_aadhar');
        if (aadharField) {
            aadharField.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 12) value = value.substring(0,12);
                let formatted = value;
                if (formatted.length > 4) formatted = formatted.substring(0,4) + '-' + formatted.substring(4);
                if (formatted.length > 9) formatted = formatted.substring(0,9) + '-' + formatted.substring(9);
                e.target.value = formatted;
                clearFieldError.call(e.target);
            });
        }

        const panField = document.getElementById('id_pan_no');
        if (panField) {
            panField.addEventListener('input', function(e) {
                e.target.value = e.target.value.toUpperCase();
                clearFieldError.call(e.target);
            });
        }
    }

    // Simple business structure change handler
    function handleBusinessStructureChange(e) {
        console.log('Business structure changed to:', this.value);
        clearFieldError.call(this);
    }

    function validateForm() {
        let isValid = true;
        const mandatoryFields = [
            'client_name', 'primary_contact_name', 'pan_no', 'email',
            'phone_number', 'address_line1', 'aadhar', 'city', 'state',
            'postal_code', 'country', 'date_of_engagement', 'assigned_ca',
            'client_type', 'status'
        ];

        // Validate all basic mandatory fields
        mandatoryFields.forEach(fieldName => {
            const field = document.getElementById(`id_${fieldName}`);
            if (field) {
                const event = new Event('blur', { bubbles: true });
                field.dispatchEvent(event);
                if (field.classList.contains('is-invalid')) isValid = false;
            }
        });

        // Validate business structure field
        const businessStructureField = document.getElementById('id_business_structure');
        const clientTypeField = document.getElementById('id_client_type');

        if (businessStructureField && clientTypeField) {
            const clientType = clientTypeField.value ? clientTypeField.value.toLowerCase() : '';
            const businessStructure = businessStructureField.value ? businessStructureField.value.trim() : '';

            console.log('Final validation - Client type:', clientType, 'Business structure:', businessStructure);

            if (clientType === 'entity' && !businessStructure) {
                showFieldError(businessStructureField, 'Business structure is required for Entity clients.');
                isValid = false;
            } else {
                clearFieldError.call(businessStructureField);
            }
        }

        if (!isValid) {
            showTemporaryAlert('Please fix the validation errors before proceeding.', 'error');
            // Scroll to first error
            const firstError = document.querySelector('.is-invalid');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        return isValid;
    }

    // --------- Business Form Validation ----------
    function setupBusinessFormValidation() {
        const businessForm = document.querySelector('#businessStructureDetailsForm');
        if (!businessForm) {
            console.log('No business form found for validation setup');
            return;
        }

        console.log('Setting up business form validation for all fields...');

        // Get all input elements
        const inputs = businessForm.querySelectorAll('input, select, textarea');
        console.log('Found', inputs.length, 'fields to setup validation for');

        inputs.forEach(input => {
            const fieldName = input.name;
            console.log('Setting up validation for field:', fieldName);

            // Remove any existing event listeners first
            input.removeEventListener('blur', validateBusinessField);
            input.removeEventListener('input', clearBusinessFieldError);
            input.removeEventListener('change', validateBusinessField);

            // Add blur event for validation
            input.addEventListener('blur', function(e) {
                console.log('Blur event on:', fieldName, 'Value:', this.value);
                validateBusinessField(e);
            });

            // Add input event for clearing errors
            input.addEventListener('input', function(e) {
                clearBusinessFieldError.call(this);
            });

            // For select fields, validate on change as well
            if (input.tagName === 'SELECT') {
                input.addEventListener('change', function(e) {
                    console.log('Change event on select:', fieldName, 'Value:', this.value);
                    validateBusinessField(e);
                });
            }

            // For checkbox fields
            if (input.type === 'checkbox') {
                input.addEventListener('change', function(e) {
                    console.log('Change event on checkbox:', fieldName, 'Checked:', this.checked);
                    validateBusinessField(e);
                });
            }

            // For file inputs
            if (input.type === 'file') {
                input.addEventListener('change', function(e) {
                    console.log('Change event on file input:', fieldName);
                    validateBusinessField(e);
                });
            }
        });

        console.log('Business form validation setup complete');
    }

    function getMandatoryFieldsForBusinessStructure() {
        // Get the business structure from hidden input
        const businessStructureInput = document.querySelector('input[name="business_structure"]');
        const businessStructure = businessStructureInput ? businessStructureInput.value : '';

        console.log('Detected business structure:', businessStructure);

        const mandatoryFields = {
            'Private Ltd': [
                'company_type', 'proposed_company_name', 'cin', 'authorised_share_capital',
                'paid_up_share_capital', 'number_of_directors', 'number_of_shareholders',
                'registered_office_address', 'date_of_incorporation', 'udyam_registration', 'directors'
            ],
            'Public Ltd': [
                'company_type', 'proposed_company_name', 'cin', 'authorised_share_capital',
                'paid_up_share_capital', 'number_of_directors', 'number_of_shareholders',
                'registered_office_address', 'date_of_incorporation', 'udyam_registration', 'directors'
            ],
            'LLP': [
                'llp_name', 'llp_registration_no', 'registered_office_address_llp',
                'designated_partners', 'paid_up_capital_llp', 'date_of_registration_llp'
            ],
            'OPC': [
                'opc_name', 'opc_cin', 'registered_office_address_opc',
                'sole_member_name', 'nominee_member_name', 'paid_up_share_capital_opc', 'date_of_incorporation_opc'
            ],
            'Section 8': [
                'section8_company_name', 'registration_no_section8', 'registered_office_address_s8',
                'object_clause', 'whether_licence_obtained', 'date_of_registration_s8'
            ],
            'HUF': [
                'huf_name', 'pan_huf', 'date_of_creation', 'karta_name',
                'number_of_coparceners', 'number_of_members', 'residential_address', 'business_activity'
            ]
        };

        const fields = mandatoryFields[businessStructure] || [];
        console.log('Mandatory fields for', businessStructure, ':', fields);
        return fields;
    }

    function validateBusinessField(e) {
        const field = e.target;
        const fieldName = field.name;
        let value;

        // Handle different field types
        if (field.type === 'checkbox') {
            value = field.checked;
        } else if (field.type === 'file') {
            value = field.files.length > 0 ? field.files[0].name : '';
        } else if (field.tagName === 'SELECT' && field.multiple) {
            value = Array.from(field.selectedOptions).map(opt => opt.value);
        } else {
            value = field.value ? field.value.trim() : '';
        }

        console.log('Validating business field:', fieldName, 'Type:', field.type, 'Value:', value);

        // Clear previous error
        clearBusinessFieldError.call(field);

        // Check if field is mandatory
        const mandatoryFields = getMandatoryFieldsForBusinessStructure();
        const isMandatory = mandatoryFields.includes(fieldName);

        console.log('Is mandatory field:', isMandatory, 'Mandatory fields:', mandatoryFields);

        // Required field validation
        if (isMandatory) {
            let isEmpty = false;

            if (field.type === 'checkbox') {
                isEmpty = !value;
            } else if (field.tagName === 'SELECT' && field.multiple) {
                isEmpty = value.length === 0;
            } else if (field.type === 'file') {
                isEmpty = !value;
            } else {
                isEmpty = !value || value === '';
            }

            if (isEmpty) {
                console.log('Field is mandatory and empty:', fieldName);
                showBusinessFieldError(field, 'This field is required.');
                return false;
            }
        }

        // For non-mandatory fields with no value, skip further validation
        if (!value || value === '' || (Array.isArray(value) && value.length === 0)) {
            return true;
        }

        // Field-specific validations
        return validateBusinessFieldSpecificRules(field, fieldName, value);
    }

    function validateBusinessFieldSpecificRules(field, fieldName, value) {
        switch(fieldName) {
            case 'udyam_registration':
                if (!/^UDYAM-[A-Z]{2}-\d{2}-\d{7}$/.test(value)) {
                    showBusinessFieldError(field, 'Please enter a valid Udyam registration number (format: UDYAM-XX-XX-XXXXXXX).');
                    return false;
                }
                break;

            case 'authorised_share_capital':
            case 'paid_up_share_capital':
            case 'paid_up_capital_llp':
            case 'paid_up_share_capital_opc':
                const capitalValue = parseFloat(value);
                if (isNaN(capitalValue) || capitalValue < 0) {
                    showBusinessFieldError(field, 'Please enter a valid capital amount (positive number).');
                    return false;
                }
                if (capitalValue > 1000000000) {
                    showBusinessFieldError(field, 'Capital amount seems too high. Please verify.');
                    return false;
                }
                break;

            case 'number_of_directors':
            case 'number_of_shareholders':
            case 'number_of_coparceners':
            case 'number_of_members':
                const numValue = parseInt(value);
                if (isNaN(numValue) || numValue < 1) {
                    showBusinessFieldError(field, 'Please enter a valid number (at least 1).');
                    return false;
                }
                if (numValue > 100) {
                    showBusinessFieldError(field, 'Number seems too high. Please verify.');
                    return false;
                }
                break;

            case 'email':
                if (!isValidEmail(value)) {
                    showBusinessFieldError(field, 'Please enter a valid email address.');
                    return false;
                }
                break;
        }

        return true;
    }

    function showBusinessFieldError(field, message) {
        field.classList.add('is-invalid');
        const errorElement = document.getElementById(`${field.name}_error`);
        if (errorElement) {
            errorElement.textContent = message;
        }
    }

    function clearBusinessFieldError() {
        this.classList.remove('is-invalid');
        const errorElement = document.getElementById(`${this.name}_error`);
        if (errorElement) {
            errorElement.textContent = '';
        }
    }

    function validateBusinessForm() {
        const businessForm = document.querySelector('#businessStructureDetailsForm');
        if (!businessForm) {
            console.log('No business form found for validation');
            return true;
        }

        let isValid = true;
        const mandatoryFields = getMandatoryFieldsForBusinessStructure();

        console.log('Validating business form with mandatory fields:', mandatoryFields);

        // Validate all mandatory fields
        mandatoryFields.forEach(fieldName => {
            let field = businessForm.querySelector(`[name="${fieldName}"]`);

            // If field not found with exact name, try alternative selectors
            if (!field) {
                // Try by ID
                field = document.getElementById(`id_${fieldName}`);
            }

            if (field) {
                console.log('Validating mandatory field:', fieldName);
                // Create and dispatch blur event to trigger validation
                const event = new Event('blur', { bubbles: true });
                field.dispatchEvent(event);

                // Check if field has error
                if (field.classList.contains('is-invalid')) {
                    console.log('Field has error:', fieldName);
                    isValid = false;
                }
            } else {
                console.warn('Mandatory field not found in form:', fieldName);

                // Log available fields for debugging
                const allFields = businessForm.querySelectorAll('input, select, textarea');
                const fieldNames = Array.from(allFields).map(f => f.name).filter(name => name);
                console.log('Available fields in form:', fieldNames);
            }
        });

        if (!isValid) {
            showTemporaryAlert('Please fix the validation errors before submitting.', 'error');
            // Scroll to first error
            const firstError = businessForm.querySelector('.is-invalid');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        } else {
            console.log('Business form validation passed');
        }

        return isValid;
    }

    // --------- Button / flow helpers ----------
    function updateSubmitButtons() {
        if (!submitButtonsContainer) return;
        submitButtonsContainer.innerHTML = '';

        if (currentState === 'basic') {
            if (clientTypeField && clientTypeField.value && clientTypeField.value.toLowerCase() === 'individual') {
                const submitButton = document.createElement('button');
                submitButton.type = 'button';
                submitButton.className = 'btn btn-success';
                submitButton.textContent = 'Submit';
                submitButton.onclick = submitIndividualForm;
                submitButtonsContainer.appendChild(submitButton);
            } else {
                const nextButton = document.createElement('button');
                nextButton.type = 'button';
                nextButton.className = 'btn btn-primary';
                nextButton.textContent = 'Next';
                nextButton.onclick = handleNextButtonClick;
                submitButtonsContainer.appendChild(nextButton);
            }
        } else if (currentState === 'business') {
            const back = document.createElement('button');
            back.type = 'button';
            back.className = 'btn btn-secondary me-2';
            back.id = 'bizBackBtn';
            back.textContent = 'Back';
            back.onclick = goBackToBasicForm;

            const save = document.createElement('button');
            save.type = 'button';
            save.className = 'btn btn-success';
            save.id = 'bizSaveBtn';
            save.textContent = 'Save';
            save.onclick = function() {
                const form = businessStructureForm.querySelector('#businessStructureDetailsForm');
                if (form && validateBusinessForm()) {
                    form.requestSubmit();
                }
            };

            submitButtonsContainer.appendChild(back);
            submitButtonsContainer.appendChild(save);
        }
    }

    // --------- AJAX functions ----------
    async function submitIndividualForm() {
        if (!validateForm()) {
            console.log('Form validation failed, blocking submission');
            return;
        }

        showLoading();
        try {
            const formData = new FormData(clientBasicForm);
            const res = await fetch('{% url "save_client_basic" %}', {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': csrfToken, 'X-Requested-With': 'XMLHttpRequest' }
            });
            const data = await res.json();
            if (data.success) {
                if (data.redirect_to_complete && data.client_type && data.client_type.toLowerCase() === 'individual') {
                    await finalizeIndividualClient();
                } else if (data.redirect_url) {
                    hideLoading();
                    window.location.href = data.redirect_url;
                } else if (data.form_html) {
                    showBusinessStructureForm(data);
                } else {
                    hideLoading();
                    showTemporaryAlert('Client saved.', 'success');
                }
            } else {
                hideLoading();
                handleFormErrors(data);
            }
        } catch (err) {
            console.error('submitIndividualForm error:', err);
            hideLoading();
            showTemporaryAlert('Network error occurred. Please try again.', 'error');
        }
    }

    async function finalizeIndividualClient() {
        try {
            const res = await fetch('{% url "save_individual_client" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            const data = await res.json();

            // Add a small delay to ensure loading is hidden
            setTimeout(() => {
                hideLoading();

                if (data.success) {
                    showSuccessModal(data.client_id, data.client_name);
                } else {
                    handleFormErrors(data);
                }
            }, 300);

        } catch (err) {
            console.error('finalizeIndividualClient error:', err);
            setTimeout(hideLoading, 300);
            showTemporaryAlert('Network error occurred while finalizing.', 'error');
        }
    }

    async function handleNextButtonClick() {
        if (requestInFlight) return;

        // Validate form BEFORE showing loading modal
        if (!validateForm()) {
            console.log('Form validation failed, blocking submission');
            return;
        }

        requestInFlight = true;
        showLoading();

        try {
            const formData = new FormData(clientBasicForm);
            const res = await fetch('{% url "save_client_basic" %}', {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': csrfToken, 'X-Requested-With': 'XMLHttpRequest' }
            });

            if (!res.ok) {
                const text = await res.text().catch(()=>null);
                throw new Error('HTTP ' + res.status + ' — ' + (text || ''));
            }

            const data = await res.json();
            if (data.success) {
                if (data.form_html) {
                    showBusinessStructureForm(data);
                } else if (data.redirect_url) {
                    hideLoading();
                    window.location.href = data.redirect_url;
                } else {
                    hideLoading();
                    showTemporaryAlert('Unexpected response from server.', 'error');
                }
            } else {
                hideLoading();
                handleFormErrors(data);
            }
        } catch (err) {
            console.error('handleNextButtonClick error:', err);
            hideLoading();
            showTemporaryAlert('Network error occurred. Please try again.', 'error');
        } finally {
            requestInFlight = false;
        }
    }

    function showBusinessStructureForm(data) {
        console.log('Loading business structure form...');

        currentState = 'business';
        destroySelect2(clientBasicForm);

        clientBasicForm.style.display = 'none';
        businessStructureForm.style.display = 'block';
        businessStructureForm.innerHTML = data.form_html;

        // Hide loading
        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                try { hideLoading(); } catch(e){ console.error(e); }
            });
        });

        setTimeout(() => { hideLoading(); }, 250);
        setTimeout(() => { hideLoading(); }, 600);

        if (formTitle) formTitle.style.display = 'none';

        // Initialize after a delay
        setTimeout(() => {
            console.log('Initializing business form components...');
            initializeSelect2(businessStructureForm);
            setupBusinessFormValidation(); // This sets up real-time validation
            attachBusinessFormHandlers();

            // Test that validation is working
            console.log('Validation setup complete, testing field detection...');
            const testFields = businessStructureForm.querySelectorAll('input, select, textarea');
            console.log('Total fields found:', testFields.length);
            testFields.forEach(field => {
                console.log('Field:', field.name, 'Type:', field.type, 'ID:', field.id);
            });

        }, 200);

        updateSubmitButtons();
        window.scrollTo(0, 0);

        console.log('Business structure form loaded');
    }

    function attachBusinessFormHandlers() {
        const backButton = businessStructureForm.querySelector('#backButton');
        if (backButton) {
            backButton.addEventListener('click', goBackToBasicForm);
        }

        const businessForm = businessStructureForm.querySelector('#businessStructureDetailsForm');
        if (businessForm) {
            businessForm.addEventListener('submit', function(e) {
                e.preventDefault();
                if (validateBusinessForm()) {
                    submitBusinessStructureForm(businessForm);
                }
            });

            // File upload feedback
            const fileInputs = businessForm.querySelectorAll('input[type="file"]');
            fileInputs.forEach(input => {
                input.addEventListener('change', function(e) {
                    const feedback = this.closest('.col-md-6')?.querySelector('.file-upload-feedback');
                    if (feedback && this.files.length > 0) {
                        feedback.style.display = 'block';
                        const fileName = this.files[0].name;
                        feedback.innerHTML = `<small class="text-success"><i class="bi bi-check-circle"></i> ${fileName}</small>`;
                    } else if (feedback) {
                        feedback.style.display = 'none';
                    }
                });
            });
        }
    }

    async function submitBusinessStructureForm(form) {
        showLoading();
        try {
            const formData = new FormData(form);

            const res = await fetch('{% url "save_client_complete" %}', {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': csrfToken }
            });

            if (!res.ok) throw new Error('HTTP ' + res.status);

            const data = await res.json();

            // IMPORTANT: Hide loading BEFORE showing success
            hideLoading();

            // Add a small delay to ensure loading is completely hidden
            setTimeout(() => {
                if (data.success) {
                    showSuccessModal(data.client_id, data.client_name);
                } else {
                    handleFormErrors(data);
                }
            }, 300);

        } catch (err) {
            console.error('submitBusinessStructureForm error:', err);
            hideLoading();
            showTemporaryAlert('Network error occurred. Please try again.', 'error');
        }
    }

    function goBackToBasicForm() {
        currentState = 'basic';
        destroySelect2(businessStructureForm);

        businessStructureForm.style.display = 'none';
        businessStructureForm.innerHTML = '';
        clientBasicForm.style.display = 'block';

        if (formTitle) {
            formTitle.style.display = 'block';
            formTitle.innerHTML = 'Client Basic Information <small class="text-muted">(<span class="text-danger">*</span> indicates required field)</small>';
        }

        setTimeout(() => {
            initializeSelect2(clientBasicForm);
            setupRealTimeValidation();
            attachClientTypeChange();
        }, 80);

        fetch('{% url "clear_client_session" %}', {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken, 'X-Requested-With': 'XMLHttpRequest' },
            keepalive: true
        }).catch(()=>{});

        updateSubmitButtons();
        window.scrollTo(0, 0);
    }

    // --------- success modal ----------
    function showSuccessModal(clientId, clientName) {
        // Ensure any existing modals are properly closed first
        const existingModals = document.querySelectorAll('.modal.show');
        existingModals.forEach(modal => {
            if (modal.id !== 'successModal') {
                modal.classList.remove('show');
                modal.style.display = 'none';
            }
        });

        // Set success modal content
        document.getElementById('successClientId').textContent = clientId;
        document.getElementById('successClientName').textContent = clientName;

        // Initialize and show success modal
        const successModalElement = document.getElementById('successModal');
        const successModal = new bootstrap.Modal(successModalElement, {
            backdrop: 'static',
            keyboard: false
        });

        // Set up the OK button handler
        document.getElementById('successOkButton').onclick = function() {
            successModal.hide();
            window.location.href = '{% url "clients" %}';
        };

        // Show the success modal
        successModal.show();
    }

    // --------- form errors helper ----------
    function handleFormErrors(data) {
        if (!data) return;
        if (data.errors) {
            for (let field in data.errors) {
                const elem = document.getElementById(`id_${field}`);
                if (elem) showFieldError(elem, data.errors[field].join(', '));
            }
            showTemporaryAlert('Please fix the form errors before submitting.', 'error');
        } else if (data.error) {
            showTemporaryAlert('Error: ' + data.error, 'error');
        } else {
            showTemporaryAlert('An unknown error occurred.', 'error');
        }
    }

    // --------- temporary alert ----------
    function showTemporaryAlert(message, type) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const alertHtml = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle-fill"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        const main = document.querySelector('main');
        const existing = main.querySelectorAll('.alert');
        existing.forEach(e => e.remove());
        main.insertAdjacentHTML('afterbegin', alertHtml);
        setTimeout(() => {
            const alert = main.querySelector('.alert');
            if (alert) {
                try { new bootstrap.Alert(alert).close(); } catch (e) {}
            }
        }, 5000);
    }

    // --------- client type change ----------
    function attachClientTypeChange() {
        // Remove any existing event listeners
        try {
            $('#'+clientTypeSelectId).off('change.select2-client-type');
        } catch(e){}

        // Add new event listener with namespace
        $('#'+clientTypeSelectId).on('change.select2-client-type', function() {
            console.log('Client type changed to:', this.value);
            toggleBusinessStructure();
            updateSubmitButtons();

            // Clear business structure error when client type changes
            const businessStructureField = document.getElementById('id_business_structure');
            if (businessStructureField) {
                clearFieldError.call(businessStructureField);

                // If changing to non-entity, clear the value too
                const clientType = this.value ? this.value.toLowerCase() : '';
                if (clientType !== 'entity') {
                    businessStructureField.value = '';
                }
            }
        });

        // Also trigger initially to set correct state
        setTimeout(() => {
            toggleBusinessStructure();
            updateSubmitButtons();
        }, 200);
    }

    function toggleBusinessStructure() {
        if (!businessStructureField || !clientTypeField) return;

        const clientType = clientTypeField.value ? clientTypeField.value.toLowerCase() : '';
        console.log('Toggle business structure for client type:', clientType);

        if (clientType === 'entity') {
            businessStructureField.style.display = 'block';
        } else {
            businessStructureField.style.display = 'none';
            // Clear business structure value for non-entity types
            const businessStructureFieldInput = document.getElementById('id_business_structure');
            if (businessStructureFieldInput) {
                businessStructureFieldInput.value = '';
                clearFieldError.call(businessStructureFieldInput);
            }
        }
    }

    // --------- clear form flow ----------
    clearButton.addEventListener('click', function() {
        const clearFormModal = new bootstrap.Modal(document.getElementById('clearFormModal'));
        clearFormModal.show();
    });

    confirmClearButton.addEventListener('click', function() {
        destroySelect2();
        fetch('{% url "clear_client_session" %}', {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken, 'X-Requested-With': 'XMLHttpRequest' }
        }).finally(() => {
            clientBasicForm.reset();
            const selects = clientBasicForm.querySelectorAll('select');
            selects.forEach(s => s.selectedIndex = 0);
            const errorElements = clientBasicForm.querySelectorAll('.invalid-feedback');
            errorElements.forEach(el => el.textContent = '');
            const invalidFields = clientBasicForm.querySelectorAll('.is-invalid');
            invalidFields.forEach(f => f.classList.remove('is-invalid'));

            initializeForm();
            showTemporaryAlert('Form cleared successfully!', 'success');

            const clearModal = bootstrap.Modal.getInstance(document.getElementById('clearFormModal'));
            if (clearModal) clearModal.hide();
        });
    });

    // --------- initialize everything ----------
    function initializeForm() {
        currentState = 'basic';
        clientBasicForm.style.display = 'block';
        businessStructureForm.style.display = 'none';
        businessStructureForm.innerHTML = '';
        if (formTitle) {
            formTitle.style.display = 'block';
            formTitle.innerHTML = 'Client Basic Information <small class="text-muted">(<span class="text-danger">*</span> indicates required field)</small>';
        }

        setTimeout(() => {
            initializeSelect2(clientBasicForm);
            setupRealTimeValidation();
            attachClientTypeChange();
            updateSubmitButtons();
        }, 120);
    }

    // Start
    initializeForm();
});
</script>
{% endblock body %}