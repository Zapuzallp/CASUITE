{% extends 'base.html' %}
{% block body %}

<main id="main" class="main">
  <div class="pagetitle">
    <h1>Invoices for Payment</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item">
          <a href="{% url 'dashboard' %}">Home</a>
        </li>
        <li class="breadcrumb-item active">Payments</li>
      </ol>
    </nav>
  </div>

  <section class="section">
    <div class="card shadow-sm border-0">
      <div class="card-body">

        <!-- HEADER -->
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="card-title mb-0">All Generated Invoices</h5>
          <a href="{% url 'payment_list' %}" class="btn btn-primary btn-sm">
            View All Payment History
          </a>
        </div>

        <!-- TABLE -->
        <table class="table table-hover datatable align-middle">
          <thead class="table-light">
            <tr>
              <th>Invoice No</th>
              <th>Client</th>
              <th>Total Amount</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>

          <tbody>
            {% for inv in invoices %}
            <tr>
              <td>{{ inv.invoice_number }}</td>
              <td>{{ inv.client.client_name }}</td>
              <td>₹ {{ inv.total_amount }}</td>

              <!-- STATUS -->
              <td>
                {% if inv.remaining <= 0 %}
                  <span class="badge bg-success">Paid</span>
                {% elif inv.total_paid > 0 %}
                  <span class="badge bg-warning text-dark">Partial</span>
                {% else %}
                  <span class="badge bg-danger">Unpaid</span>
                {% endif %}
              </td>

              <!-- ACTION -->
              <td>
                {% if inv.remaining > 0 %}
                  <button
                    type="button"
                    class="btn btn-sm btn-primary"
                    data-bs-toggle="modal"
                    data-bs-target="#collectPaymentModal"
                    data-invoice-id="{{ inv.id }}"
                    data-invoice-no="{{ inv.invoice_number }}"
                    data-client="{{ inv.client.client_name }}"
                    data-remaining="{{ inv.remaining }}"
                  >
                    Collect Payment
                  </button>
                {% else %}
                  <span class="text-muted">Completed</span>
                {% endif %}
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="5" class="text-center text-muted">
                No invoices found.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

      </div>
    </div>
  </section>
</main>

<!-- ================= COLLECT PAYMENT MODAL ================= -->

<div class="modal fade" id="collectPaymentModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">

      <form method="POST" id="collectPaymentForm">
        {% csrf_token %}

        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Collect Payment</h5>
          <button type="button"
                  class="btn-close btn-close-white"
                  data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">

          <!-- INVOICE SUMMARY -->
          <div class="row mb-3">
            <div class="col-md-4">
              <strong>Invoice:</strong>
              <div id="mInvoiceNo"></div>
            </div>
            <div class="col-md-4">
              <strong>Client:</strong>
              <div id="mClient"></div>
            </div>
            <div class="col-md-4">
              <strong>Remaining:</strong>
              ₹ <span id="mRemaining"></span>
            </div>
          </div>

          <hr>

          <!-- PAYMENT DETAILS -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label fw-bold">Method</label>
              <select name="payment_method" class="form-select" required>
                <option value="">-- Select --</option>
                <option value="CASH">Cash</option>
                <option value="UPI">UPI</option>
                <option value="BANK">Bank</option>
                <option value="CHECK">Check</option>
              </select>
            </div>

            <div class="col-md-6 mb-3">
              <label class="form-label fw-bold">Amount</label>
              <input type="number"
                     step="0.01"
                     name="amount"
                     id="mAmount"
                     class="form-control"
                     required>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label fw-bold">Date</label>
              <input type="date"
                     name="payment_date"
                     class="form-control"
                     value="{% now 'Y-m-d' %}">
            </div>

            <div class="col-md-6 mb-3">
              <label class="form-label fw-bold">Transaction ID</label>
              <input type="text"
                     name="transaction_id"
                     class="form-control">
            </div>
          </div>

        </div>

        <div class="modal-footer">
          <button type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="submit"
                  class="btn btn-primary">
            Save Payment
          </button>
        </div>

      </form>
    </div>
  </div>
</div>

<!-- ================= SCRIPT ================= -->

<script>
document
  .getElementById('collectPaymentModal')
  .addEventListener('show.bs.modal', function (event) {

    const btn = event.relatedTarget;

    const invoiceId = btn.dataset.invoiceId;
    const invoiceNo = btn.dataset.invoiceNo;
    const client = btn.dataset.client;
    const remaining = btn.dataset.remaining;

    document.getElementById('mInvoiceNo').innerText = invoiceNo;
    document.getElementById('mClient').innerText = client;
    document.getElementById('mRemaining').innerText = remaining;

    const amountInput = document.getElementById('mAmount');
    amountInput.value = remaining;
    amountInput.max = remaining;

    document.getElementById('collectPaymentForm').action =
      `/payment/${invoiceId}/collect/`;
  });
</script>

{% endblock body %}
